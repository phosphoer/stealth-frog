(function(a,b){a.File=function(a){this.path=a;this.request=new XMLHttpRequest;this.fileData=null};a.File.prototype.Read=function(a,c,b){if(!this.path)return console.log("TomatoJS.File: Cannot read file with filepath: "+this.filePath),null;c||(c=!1);this.request.open("GET",this.path+"?t="+Math.random(),c);a&&(this.request.responseType=a);if(c){var e=this;this.request.onload=function(){e.fileData=a?e.request.response:decodeURIComponent(unescape(e.request.responseText));b&&b(e)}}this.request.send();
c||(this.fileData=a?this.request.response:decodeURIComponent(unescape(this.request.responseText)));return this.fileData};a.File.prototype.Write=function(a){if(!this.path)return console.log("TomatoJS.File: Cannot write file with no path"),!1;this.request.open("POST","php/WriteFile.php",!0);this.request.setRequestHeader("Content-type","application/x-www-form-urlencoded");this.request.setRequestHeader("X-File-Name",this.path);this.request.send("data="+a);return!0};a.File.prototype.Download=function(a){a=
"data:application/octet-stream,"+encodeURIComponent(escape(a));a="<div id='downloadBox'><input id='downloadInput'> </input>"+("<a id='downloadLink' href='"+a+"' download='testFile.dat'>Download File</a></div>");b(a).dialog({title:"Save File"});b("#downloadLink").button();b("#downloadLink").css({margin:"auto",display:"block"});b("#downloadInput").css({margin:"auto",display:"block"});b("#downloadInput").val("File Name.txt");b("#downloadLink").mousedown(function(){b(this).attr("download",b("#downloadInput").val())});
b("#downloadLink").click(function(){b("#downloadBox").remove()})};a.File.prototype.GetJSONObject=function(){var a=null;try{a=JSON.parse(this.fileData)}catch(c){return console.log("TomatoJS.File: Failed to parse as JSON: "+this.path+" (Error Message: "+c.message+")"),null}return a}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b){a.FileManager=function(){this.loadedFiles={}};a.FileManager.prototype.OpenFile=function(b,c,f,e){var h=this.loadedFiles[b];h?e&&e(h):(h=new a.File(b),h.Read(c,f,e),this.loadedFiles[b]=h);return h};a.FileManager.prototype.OpenFileDialog=function(a,c){var f;f="<div id='openBox'><input id='openInput'> </input><div id='openLink'>Ok</div></div>";b(f).dialog({title:"Open File"});b("#openLink").button();b("#openLink").css({margin:"auto",display:"block"});b("#openInput").css({margin:"auto",
display:"block"});b("#openInput").val(c?c:"File Name.txt");b("#openInput").keypress(function(a){13==a.keyCode&&b("#openLink").click()});var e="";b("#openLink").click(function(){e=b("#openInput").val();b("#openBox").remove();a(e)})};a.FileManager.prototype.WriteFile=function(b,c){(new a.File(b)).Write(c)}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.Rand=function(a,d){return!a||!d?Math.random():a+Math.random()*(d-a)};a.NormalizeInRange=function(a,d,c){a=Math.max((c-a)/(d-a),0);return a=Math.min(a,1)};a.Lerp=function(a,d,c){return(1-c)*a+d*c};a.Vec2Add=function(a,d){return[a[0]+d[0],a[1]+d[1]]};a.Vec2Subtract=function(a,d){return[a[0]-d[0],a[1]-d[1]]};a.Vec2Dot=function(a,d){return a[0]*d[0]+a[1]*d[1]};a.Vec2Scale=function(a,d){return[a[0]*d,a[1]*d]};a.Vec2Length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])};a.Vec2LengthSquared=
function(a){return a[0]*a[0]+a[1]*a[1]};a.Vec2FromAngle=function(a){return[Math.cos(a),Math.sin(a)]};a.Vec2Normalize=function(b){var d=a.Vec2Length(b);1E-4>d||(b[0]/=d,b[1]/=d)};a.Vec2Normalized=function(b){var d=a.Vec2Length(b);return 1E-4>d?[0,0]:a.Vec2Scale(b,1/d)};a.Vec2ProjectLine=function(b,d,c){var b=a.Vec2Subtract(b,d),f=a.Vec2LengthSquared(c);if(0==f)return[d[0],d[1]];b=a.Vec2Dot(b,Vec2Scale(c,1/f));return a.Vec2Add(d,Vec2Scale(c,b))};a.Vec2DistancePoint=function(a,d){return Math.sqrt((d[0]-
a[0])*(d[0]-a[0])+(d[1]-a[1])*(d[1]-a[1]))};a.Vec2DistanceLine=function(b,d,c){d=a.Vec2ProjectLine(b,d,c);return a.Vec2DistancePoint(b,d)};a.Vec2ContainedInRect=function(a,d,c){return a[0]<d[0]||a[1]<d[1]||a[0]>d[0]+c[0]||a[1]>d[1]+c[1]?!1:!0};a.IntersectLineSegments=function(a,d,c,f,e){var d=[d[0]-a[0],d[1]-a[1]],h=[f[0]-c[0],f[1]-c[1]],f=d[0]*h[1]-d[1]*h[0];if(0==f)return!1;c=[c[0]-a[0],c[1]-a[1]];h=(c[0]*h[1]-c[1]*h[0])/f;if(0>h||1<h)return!1;c=(c[0]*d[1]-c[1]*d[0])/f;if(0>c||1<c)return!1;e[0]=
a[0]+h*d[0];e[1]=a[1]+h*d[1];return!0};a.AngleDistance=function(a,d){a%=2*Math.PI;d%=2*Math.PI;0>a&&(a+=2*Math.PI);0>d&&(d+=2*Math.PI);if(Math.abs(d-a)<Math.PI)return d-a;if(d>Math.PI)return a+=Math.PI,d-=Math.PI,d-a;a-=Math.PI;d+=Math.PI;return d-a}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.PropertyAnimator=function(){this.animations=[];this.finishedAnimations=[]};a.PropertyAnimator.prototype.Update=function(b){for(var d in this.animations){var c;c=this.animations[d];c.done?c=!0:(c.currentTime+=b,null==c.from&&(c.from=c.obj[c.property]),c.obj[c.property]=a.Lerp(c.from,c.to,c.currentTime/c.duration),1<=c.currentTime/c.duration?(c.obj[c.property]=c.to,c.done=!0,c.doneCallback&&c.doneCallback(),c=!0):c=!1);c&&this.finishedAnimations.push(d);if(this.animations[d].blocking)break}for(d in this.finishedAnimations)this.animations.splice(this.finishedAnimations[d],
1);this.finishedAnimations=[]};a.PropertyAnimator.prototype.Animate=function(a,d,c,f,e,h,g){var i={};i.obj=a;i.property=d;i.from=c;i.to=f;i.duration=e;i.blocking=h?!0:!1;i.doneCallback=g;i.currentTime=0;i.done=!1;this.animations.push(i)}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.Animatable=function(b){this.parent=b;this.animator=new a.PropertyAnimator};a.Animatable.prototype.Initialize=function(){a.Core.AddEventListener("OnFrameBegin",this)};a.Animatable.prototype.Uninitialize=function(){a.Core.RemoveEventListener("OnFrameBegin",this)};a.Animatable.prototype.OnFrameBegin=function(a){this.animator.Update(a)};a.Animatable.prototype.Animate=function(a,d,c,f,e,h){this.animator.Animate(this.parent,a,d,c,f,e,h)};a.Animatable.prototype.AnimateComponent=function(a,
d,c,f,e,h,g){this.animator.Animate(this.parent.GetComponent(a),d,c,f,e,h,g)}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b,d){var c=document.createElement("canvas"),f=c.getContext("2d"),e=document.createElement("canvas"),h=e.getContext("2d");a.PixelImage=function(a,b,d){this.url=a;this.scaled_image=new Image;this.image=new Image;this.image.src=a;this.scale=b;this.scale_position=!0;this.callbacks=[];this.loaded=!1;var j=this;this.image.onload=function(){var a=j.scaled_image,g=j.image,n=g.width,p=g.height,q=n*b,r=p*b;c.width=n;c.height=p;e.width=q;e.height=r;f.drawImage(g,0,0);for(var g=f.getImageData(0,0,
n,p).data,q=h.getImageData(0,0,q,r),r=q.data,t=0,s=0,v=0;v<p;++v)for(var x=0;x<b;++x)for(var w=0;w<n;++w)for(var t=4*(v*n+w),y=0;y<b;++y){var u=t;r[s++]=g[u++];r[s++]=g[u++];r[s++]=g[u++];r[s++]=g[u++]}h.putImageData(q,0,0);n=e.toDataURL("image/png");n.replace(/^data:image\/(png|jpg);base64,/,"");a.src=n;j.width=j.image.width;j.height=j.image.height;j.scaled_width=j.image.width*b;j.scaled_height=j.image.height*b;j.loaded=!0;d&&d(j);for(var z in j.callbacks)j.callbacks[z](j)}};a.PixelImage.prototype.AddLoadCallback=
function(a){this.callbacks.push(a)};a.PixelImage.prototype.Draw=function(a,c,b,e,f,h){e!=d?(a.save(),a.translate(Math.floor(c*this.scale+this.scaled_width/2),Math.floor(b*this.scale+this.scaled_height/2)),a.rotate(e),a.translate(Math.floor(-this.scaled_width/2-f*this.scale),Math.floor(-this.scaled_height/2-h*this.scale)),a.drawImage(this.scaled_image,0,0),a.restore()):a.drawImage(this.scaled_image,Math.ceil(c*this.scale),Math.ceil(b*this.scale))};a.PixelImage.prototype.DrawClipped=function(a,c,b,
e,f,h,n,p,q,r){h*=this.scale;n*=this.scale;p!=d?(a.save(),a.translate(Math.floor(c*this.scale+h/2),Math.floor(b*this.scale+n/2)),a.rotate(p),a.translate(Math.floor(-h/2-q*this.scale),Math.floor(-n/2-r*this.scale)),a.drawImage(this.scaled_image,e*this.scale,f*this.scale,h,n,0,0,h,n),a.restore()):a.drawImage(this.scaled_image,e*this.scale,f*this.scale,h,n,Math.ceil(c*this.scale),Math.ceil(b*this.scale),h,n)}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b){a.PreLoader=function(){this.loadedImages={}};a.PreLoader.prototype.Load=function(d){var c=this;this.BuildUI();var f=[],e=new b.Deferred,h=new b.Deferred;f.push(e);f.push(h);var g=0,i=this.LoadSounds(a.Core.configData.soundPath,function(a,b,f){c.UpdateUIProgress(b/g);f&&e.resolve()}),g=g+i.length,i=this.LoadImages(a.Core.configData.imagePath,function(a,b,e){c.UpdateUIProgress(b/g);e&&h.resolve()}),g=g+i.length;this.LoadJSON(a.Core.configData.animationPath);this.LoadJSON(a.Core.configData.blueprintPath);
this.LoadJSON(a.Core.configData.levelPath);this.LoadJSON(a.Core.configData.tilesetPath);this.LoadJSON(a.Core.configData.uiPagePath);b.when.apply(b,f).done(function(){c.RemoveUI();d()})};a.PreLoader.prototype.LoadJSON=function(b){var c=a.Core.fileManager.OpenFile(b+"Preload.json").GetJSONObject(),f;for(f in c)a.Core.fileManager.OpenFile(b+c[f])};a.PreLoader.prototype.LoadSounds=function(d,c){function f(f,d){var g=new b.Deferred;h.push(g);a.Core.fileManager.OpenFile(f,"arraybuffer",!0,function(){c(e,
d,!1);g.resolve()})}var e=a.Core.fileManager.OpenFile(d+"Preload.json").GetJSONObject(),h=[],g;for(g in e)f(d+e[g],g);b.when.apply(b,h).done(function(){c(e,g,!0)});return e};a.PreLoader.prototype.LoadImages=function(d,c){function f(b,f,d){g.loadedImages[e[f]]=new a.PixelImage(b,a.CoreScale,function(){c(e,f,!1);d.resolve()})}var e=a.Core.fileManager.OpenFile(d+"Preload.json").GetJSONObject(),h=[],g=this,i;for(i in e){var k=new b.Deferred;h.push(k)}for(i in e)f(d+e[i],i,h[i]);b.when.apply(b,h).done(function(){c(e,
i,!0)});return e};a.PreLoader.prototype.BuildUI=function(){var a;a="<div id='preloader'><div id='preloader-progress'></div>";a+="</div>";b(a).appendTo("body");b("#preloader-progress").progressbar({value:1});b("#preloader-progress").css({position:"absolute","font-size":"60px",left:"10%",top:"40%",width:"80%",height:"20%",display:"block"})};a.PreLoader.prototype.UpdateUIProgress=function(a){var c=setInterval(function(){var f=b("#preloader-progress").progressbar("value");b("#preloader-progress").progressbar("value",
f+1);b("#preloader-progress").progressbar("value")>=100*a&&clearInterval(c)},10)};a.PreLoader.prototype.RemoveUI=function(){b("#preloader").remove()}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.ResourceManager=function(){this.loadedAnimations={};this.loadedBlueprints={};this.loadedImages={};this.loadedLevels={};this.loadedTilesets={};this.loadedUIPages={};this.loadedUIStyles={};this.loader=new a.PreLoader};a.ResourceManager.prototype.ReplaceExtension=function(a,d){var c=a.lastIndexOf(".");0<c&&(a=a.substring(0,c));return a+d};a.ResourceManager.prototype.Load=function(a){var d=this;this.loader.Load(function(){d.loadedImages=d.loader.loadedImages;a()})};a.ResourceManager.prototype.GetAnimation=
function(b){var b=this.ReplaceExtension(b,".animation"),d=this.loadedAnimations[b];if(!d){var c=a.Core.fileManager.OpenFile(a.Core.configData.animationPath+b).GetJSONObject(),d=new a.Animation,f;for(f in c)d[f]=c[f];this.loadedAnimations[b]=d;d.Initialize()}return d};a.ResourceManager.prototype.GetBlueprint=function(b){var b=this.ReplaceExtension(b,".blueprint"),d=this.loadedBlueprints[b];d||(d=a.Core.fileManager.OpenFile(a.Core.configData.blueprintPath+b).GetJSONObject())&&(this.loadedBlueprints[b]=
d);return d};a.ResourceManager.prototype.GetImage=function(b,d){var c=this.loadedImages[b];c?d&&(c.loaded?d(c):c.AddLoadCallback(d)):(c=new a.PixelImage(a.Core.configData.imagePath+b,a.CoreScale,function(){d&&d(c)}),this.loadedImages[b]=c);return c};a.ResourceManager.prototype.GetLevel=function(b){var d=this.loadedLevels[b];d||(d=a.Core.fileManager.OpenFile(a.Core.configData.levelPath+b).GetJSONObject(),this.loadedLevels[b]=d);return d};a.ResourceManager.prototype.GetSound=function(b){return a.Core.fileManager.OpenFile(a.Core.configData.soundPath+
b)};a.ResourceManager.prototype.GetTileset=function(b){var b=this.ReplaceExtension(b,".tileset"),d=this.loadedTilesets[b];if(!d){var c=a.Core.fileManager.OpenFile(a.Core.configData.tilesetPath+b).GetJSONObject(),d=new a.Tileset,f;for(f in c)d[f]=c[f];this.loadedTilesets[b]=d;d.Initialize()}return d};a.ResourceManager.prototype.GetUIPage=function(b){var b=this.ReplaceExtension(b,".uipage"),d=this.loadedUIPages[b];d||(d=a.Core.fileManager.OpenFile(a.Core.configData.uiPagePath+b).GetJSONObject(),this.loadedUIPages[b]=
d);return d}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.AudioBank=function(){function b(){d.PlaySound("_EnableMobileAudio",!1,0.1);document.removeEventListener("touchstart",b)}this.context=null;window.AudioContext?this.context=new AudioContext:window.webkitAudioContext?this.context=new webkitAudioContext:console.log("TomatoJS.Core: Web Audio is not supported by this browser, audio experience will be subpar");this.sounds={};this.AddSound("sound-enable.wav","_EnableMobileAudio");document.addEventListener("touchstart",b);var d=this;this.biquadFilterTypes=
{lowpass:0,highpass:1,bandpass:2,lowshelf:3,highshelf:4,peaking:5,notch:6,allpass:7};this.bankTypes={randomize:!0,multilayer:!0};this.soundData=a.Core.fileManager.OpenFile(a.Core.configData.soundPath+"List.json").GetJSONObject();for(var c in this.soundData.List){var f=this.soundData.List[c];this.AddSound(f.fileName,f.name)}};a.AudioBank.prototype.AddSound=function(b,d,c){var f={};f.url=a.Core.configData.soundPath+b;f.audio=[];f.activeChannel=0;if(!this.context){c||(c=1);for(var e=0;e<c;++e)f.audio.push(new Audio(b))}this.sounds[d]=
f;return!0};a.AudioBank.prototype.PlaySound=function(b,d,c){var f=this.sounds[b];if(!f)return!1;if(this.context){var e=this;a.Core.fileManager.OpenFile(f.url,"arraybuffer",!0,function(b){f.source=e.context.createBufferSource();f.source.buffer=e.context.createBuffer(b.fileData,!0);f.volume=e.context.createGainNode();f.volume.connect(e.context.destination);f.volume.gain.value=c;f.source.connect(f.volume);f.source.loop=d;f.startTime=a.Core.elapsedTime;f.paused?f.source.noteGrainOn(0,f.stoppedTime-f.startTime,
f.source.buffer.duration):f.source.noteOn(0)})}else++f.activeChannel,f.activeChannel>=f.audio.length&&(f.activeChannel=0),f.audio[f.activeChannel].loop=d,f.audio[f.activeChannel].play()};a.AudioBank.prototype.StopSound=function(b,d){var c=this.sounds[b];if(!c)return!1;this.context?(c.stoppedTime=a.Core.elapsedTime,c.source.noteOff(this.context.currentTime),c.paused=d):c.audio[c.activeChannel].pause()};a.AudioBank.prototype.StopAllSounds=function(){for(var a in this.sounds)this.context?sound.source.noteOff(this.context.currentTime):
this.sounds[a].audio[sound.activeChannel].pause()}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b){a.Input=function(){this.pressedKeys={};var d=this;window.addEventListener("keydown",function(c){var f=c.srcElement||c.target,f=b(f).is("input")||b(f).is("textarea")?!0:!1;c.keyCode==d.BACKSPACE&&!f&&(c.preventDefault(),c.stopPropagation());c.keyCode==d.ESCAPE&&(b("textarea").blur(),b("input").blur());f||(d.pressedKeys[c.keyCode]=!0,a.Core.DispatchEventDeferred("OnKeyDown",c.keyCode))},!1);window.addEventListener("keyup",function(c){var f=c.srcElement||c.target,f=b(f).is("input")||b(f).is("textarea")?
!0:!1;c.keyCode==d.BACKSPACE&&!f&&(c.preventDefault(),c.stopPropagation());f||(delete d.pressedKeys[c.keyCode],a.Core.DispatchEventDeferred("OnKeyUp",c.keyCode))},!1);window.addEventListener("contextmenu",function(a){a.stopPropagation();a.preventDefault();return!1});document.addEventListener("mousedown",function(c){var b=a.GetMousePos(c,"#mainCanvas");if(b){var e={};e.canvasX=b.x;e.canvasY=b.y;e.pageX=c.pageX;e.pageY=c.pageY;e.target=c.target;d.mouseX=e.canvasX;d.mouseY=e.canvasY;1==c.which?(d.pressedKeys[d.LEFT_MOUSE]=
!0,e.which=d.LEFT_MOUSE):3==c.which&&(d.pressedKeys[d.RIGHT_MOUSE]=!0,e.which=d.RIGHT_MOUSE);a.Core.DispatchEventDeferred("OnMouseDown",e)}},!1);document.addEventListener("mouseup",function(c){var b=a.GetMousePos(c,"#mainCanvas");if(b){var e={};e.canvasX=b.x;e.canvasY=b.y;e.pageX=c.pageX;e.pageY=c.pageY;e.target=c.target;d.mouseX=e.canvasX;d.mouseY=e.canvasY;1==c.which?(delete d.pressedKeys[d.LEFT_MOUSE],e.which=d.LEFT_MOUSE):3==c.which&&(delete d.pressedKeys[d.RIGHT_MOUSE],e.which=d.RIGHT_MOUSE);
a.Core.DispatchEventDeferred("OnMouseUp",e)}},!1);document.addEventListener("mousemove",function(c){var b=a.GetMousePos(c,"#mainCanvas");if(b){var e={};e.canvasX=b.x;e.canvasY=b.y;e.pageX=c.pageX;e.pageY=c.pageY;e.target=c.target;e.moveX=e.canvasX-d.mouseX;e.moveY=e.canvasY-d.mouseY;d.mouseX=e.canvasX;d.mouseY=e.canvasY;a.Core.DispatchEventDeferred("OnMouseMove",e)}},!1);document.addEventListener("touchstart",function(c){c.preventDefault();var c=c.originalEvent&&c.originalEvent.touches[0]||c.touches[0]||
c.changedTouches[0],b=a.GetTouchPos(c);if(b){var e={};e.canvasX=b.x;e.canvasY=b.y;e.pageX=c.pageX;e.pageY=c.pageY;d.touchX=e.canvasX;d.touchY=e.canvasY;a.Core.configData.emulateTouches&&(d.mouseX=e.canvasX,d.mouseY=e.canvasY,a.Core.DispatchEventDeferred("OnMouseDown",e));a.Core.DispatchEventDeferred("OnTouchDown",e)}},!1);document.addEventListener("touchend",function(c){c.preventDefault();var c=c.originalEvent&&c.originalEvent.touches[0]||c.touches[0]||c.changedTouches[0],b=a.GetTouchPos(c);if(b){var e=
{};e.canvasX=b.x;e.canvasY=b.y;e.pageX=c.pageX;e.pageY=c.pageY;d.touchX=e.canvasX;d.touchY=e.canvasY;a.Core.configData.emulateTouches&&(d.mouseX=e.canvasX,d.mouseY=e.canvasY,a.Core.DispatchEventDeferred("OnMouseUp",e));a.Core.DispatchEventDeferred("OnTouchUp",e)}},!1);document.addEventListener("touchmove",function(c){c.preventDefault();var c=c.originalEvent&&c.originalEvent.touches[0]||c.touches[0]||c.changedTouches[0],b=a.GetTouchPos(c);if(b){var e={};e.canvasX=b.x;e.canvasY=b.y;e.pageX=c.pageX;
e.pageY=c.pageY;e.moveX=e.canvasX-d.touchX;e.moveY=e.canvasY-d.touchY;d.touchX=e.canvasX;d.touchY=e.canvasY;a.Core.configData.emulateTouches&&(d.mouseX=e.canvasX,d.mouseY=e.canvasY,a.Core.DispatchEventDeferred("OnMouseMove",e));a.Core.DispatchEventDeferred("OnTouchMove",e)}},!1);this.touchY=this.touchX=this.mouseY=this.mouseX=0;this.LEFT_MOUSE=500;this.RIGHT_MOUSE=501;this.LEFT_ARROW=37;this.UP_ARROW=38;this.RIGHT_ARROW=39;this.DOWN_ARROW=40;this.SHIFT=16;this.BACKSPACE=8;this.ESCAPE=27;this.SPACE=
32;this.CONTROL=17;this.ALT=18;this.SUPER=91;this.A=65;this.B=66;this.C=67;this.D=68;this.E=69;this.F=70;this.G=71;this.H=72;this.I=73;this.J=74;this.K=75;this.L=76;this.M=77;this.N=78;this.O=79;this.P=80;this.Q=81;this.R=82;this.S=83;this.T=84;this.U=85;this.V=86;this.W=87;this.X=88;this.Y=89;this.Z=90;this.NUM1=49;this.NUM2=50;this.NUM3=51;this.NUM4=52;this.NUM5=53;this.NUM6=54;this.NUM7=55;this.NUM8=56;this.NUM9=57;this.NUM0=48};a.Input.prototype.IsDown=function(a){return this.pressedKeys[a]};
a.GetMousePos=function(d,c){var f=[d.target.offsetLeft,d.target.offsetTop];c&&(f=[b(c).offset().left,b(c).offset().top]);return{x:(d.clientX-f[0])/a.CoreScale,y:(d.clientY-f[1])/a.CoreScale}};a.GetTouchPos=function(b){return{x:(b.clientX-b.target.offsetLeft)/a.CoreScale,y:(b.clientY-b.target.offsetTop)/a.CoreScale}}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.RigidBody=function(a){this.parent=a;this.gravity=1E3;this.gravityEnabled=!0;this.friction=1;this.velocityY=this.velocityX=0};a.RigidBody.prototype.Initialize=function(){a.Core.AddEventListener("OnFrameBegin",this)};a.RigidBody.prototype.Uninitialize=function(){a.Core.RemoveEventListener("OnFrameBegin",this)};a.RigidBody.prototype.OnFrameBegin=function(b){a.Core.editorEnabled||(this.velocityX*=this.friction,this.velocityY*=this.friction,this.gravityEnabled&&(this.velocityY+=this.gravity*
b),this.parent.x+=this.velocityX*b,this.parent.y+=this.velocityY*b)}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.Graphics=function(){this.canvas=a.Core.canvas;this.context=this.canvas.getContext("2d");this.camera={};this.camera.x=0;this.camera.y=0;this.clearColor=[50,50,50];this.debugDrawEnabled=!1;this.renderables=[];this.sorted_renderables=[];this.debugLines=[]};a.Graphics.prototype.AddRenderable=function(a){this.renderables.push(a);this.SortEverything()};a.Graphics.prototype.RemoveRenderable=function(a){for(var d=0;d<this.renderables.length;++d)this.renderables[d]==a&&this.renderables.splice(d,
1);this.SortEverything()};a.Graphics.prototype.AddDebugLine=function(a,d,c,f,e){this.debugDrawEnabled&&this.debugLines.push({x1:a,y1:d,x2:c,y2:f,color:e})};a.Graphics.prototype.AddDebugVector=function(a,d,c,f,e){this.debugDrawEnabled&&this.AddDebugLine(a,d,a+Math.cos(c)*f,d+Math.sin(c)*f,e)};a.Graphics.prototype.AddDebugBox=function(a,d,c,f,e){this.debugDrawEnabled&&(this.AddDebugLine(a,d,a+c,d,e),this.AddDebugLine(a+c,d,a+c,d+f,e),this.AddDebugLine(a+c,d+f,a,d+f,e),this.AddDebugLine(a,d+f,a,d,e))};
a.Graphics.prototype.Update=function(b){this.context.fillStyle="rgb("+this.clearColor[0]+","+this.clearColor[1]+","+this.clearColor[2]+")";this.context.fillRect(0,0,this.canvas.width,this.canvas.height);for(var d in this.sorted_renderables)this.sorted_renderables[d].Draw(b,this.context,this.camera);this.context.lineWidth=2;var b=[],c=[];for(d in this.debugLines){var f=this.debugLines[d],b=[(f.x1-this.camera.x)*a.CoreScale,(f.y1-this.camera.y)*a.CoreScale],c=[(f.x2-this.camera.x)*a.CoreScale,(f.y2-
this.camera.y)*a.CoreScale];!(0>b[0]&&0>c[0])&&(!(0>b[1]&&0>c[1])&&!(b[0]>a.Core.canvas.width&&c[0]>a.Core.canvas.width)&&!(b[1]>a.Core.canvas.height&&c[1]>a.Core.canvas.height))&&(this.context.strokeStyle=f.color?f.color:"rgb(255, 255, 255)",this.context.beginPath(),this.context.moveTo(b[0],b[1]),this.context.lineTo(c[0],c[1]),this.context.closePath(),this.context.stroke())}this.debugLines=[]};a.Graphics.prototype.SortEverything=function(){this.sorted_renderables=[];for(var a in this.renderables)this.sorted_renderables.push(this.renderables[a]);
this.sorted_renderables.sort(function(a,c){return a.zdepth-c.zdepth})}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.Animation=function(){this.image=this.imageURL=null;this.frameHeight=this.frameWidth=16;this.frames=[];this.duration=0};a.Animation.prototype.Initialize=function(){var b=this;this.image=a.Core.resourceManager.GetImage(this.imageURL,function(a){b.framesX=a.width/b.frameWidth;b.framesY=a.height/b.frameHeight});this.duration=0;for(var d in this.frames)this.frames[d].time=this.duration,this.duration+=this.frames[d].duration};a.Animation.prototype.Draw=function(a,d,c,f,e,h,g){this.image||
this.Initialize();d=this.GetFrameAtTime(d);d=this.frames[d];this.image.DrawClipped(a,c,f,d.frame%this.framesX*this.frameWidth,Math.floor(d.frame/this.framesX)*this.frameHeight,this.frameWidth,this.frameHeight,e,h,g)};a.Animation.prototype.GetFrameAtTime=function(a){for(var a=a%this.duration,d=-1,c=0;c<this.frames.length;++c)a>=this.frames[c].time&&++d;return d};a.Animation.prototype.GetTimeAtFrame=function(a){return this.frames[a].time}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.Renderable=function(a){this.parent=a;this.imageURL="";this.zdepth=0;this.alpha=1;this.height=this.width=this.offsetY=this.offsetX=this.rotation=0;this.animations=null;this.currentAnimation="";this.elapsedTime=0;this.paused=!1};a.Renderable.prototype.Initialize=function(){var b=this;this.image=a.Core.resourceManager.GetImage(this.imageURL,function(a){b.image=a;b.UpdateSize();b.parent.Invoke("ImageLoaded")});a.Core.GetSystem("Graphics").AddRenderable(this)};a.Renderable.prototype.Uninitialize=
function(){a.Core.GetSystem("Graphics").RemoveRenderable(this)};a.Renderable.prototype.OnEdited=function(){this.image=a.Core.resourceManager.GetImage(this.imageURL);this.parent.Invoke("ImageLoaded");a.Core.GetSystem("Graphics").SortEverything()};a.Renderable.prototype.Draw=function(b,d,c){this.paused||(this.elapsedTime+=b);this.UpdateSize();b=this.parent.x-c.x-this.width/2;c=this.parent.y-c.y-this.height/2;if(!this.IsOffScreen()){1!=this.alpha&&(d.save(),d.globalAlpha=this.alpha);if(this.animations){var f=
null;this.animations&&(f=a.Core.resourceManager.GetAnimation(this.animations[this.currentAnimation]));0!=this.rotation?f.Draw(d,this.elapsedTime,b,c,this.rotation,this.offsetX,this.offsetY):f.Draw(d,this.elapsedTime,b-this.offsetX,c-this.offsetY)}else 0!=this.rotation?this.image.Draw(d,b,c,this.rotation,this.offsetX,this.offsetY):this.image.Draw(d,b-this.offsetX,c-this.offsetY);1!=this.alpha&&d.restore()}};a.Renderable.prototype.IsOffScreen=function(){this.UpdateSize();var b=a.Core.GetSystem("Graphics").camera;
return 0>(this.parent.x-b.x+this.width/2)*a.CoreScale||0>(this.parent.y-b.y+this.height/2)*a.CoreScale||(this.parent.x-b.x-this.width/2)*a.CoreScale>a.Core.canvas.width||(this.parent.y-b.y-this.height/2)*a.CoreScale>a.Core.canvas.height?!0:!1};a.Renderable.prototype.SetFrame=function(a){this.elapsedTime=this.GetAnimation().GetTimeAtFrame(a)};a.Renderable.prototype.GetAnimation=function(){return this.animations?a.Core.resourceManager.GetAnimation(this.animations[this.currentAnimation]):null};a.Renderable.prototype.UpdateSize=
function(){var b=null;this.animations&&(b=a.Core.resourceManager.GetAnimation(this.animations[this.currentAnimation]));this.width=this.animations?b.frameWidth:this.image.width;this.height=this.animations?b.frameHeight:this.image.height}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.RenderableSpline=function(){this.zdepth=0;this.alpha=1;this.strokeColor="blue";this.strokeWidth=1;this.fillShape=!1;this.fillColor="red";this.points=[];this.CleanUp()};a.RenderableSpline.prototype.CleanUp=function(){this.scaledHeight=this.scaledWidth=this.height=this.width=0;this.scaledCanvas=this.canvas=null;this.y=this.x=0;this.commited=!1};a.RenderableSpline.prototype.Initialize=function(){a.Core.GetSystem("Graphics").AddRenderable(this)};a.RenderableSpline.prototype.Uninitialize=
function(){a.Core.GetSystem("Graphics").RemoveRenderable(this)};a.RenderableSpline.prototype.Draw=function(b,d,c){!0==this.commited&&(d.save(),d.translate((this.x-c.x)*a.CoreScale,(this.y-c.y)*a.CoreScale),d.drawImage(this.scaledCanvas,0,0),d.restore())};a.RenderableSpline.prototype.IsOffScreen=function(){this.UpdateSize();var b=a.Core.GetSystem("Graphics").camera;return 0>(this.parent.x-b.x+this.scaledWidth)*a.CoreScale||0>(this.parent.y-b.y+this.scaledHeight)*a.CoreScale||(this.parent.x-b.x-this.scaledWidth)*
a.CoreScale>a.Core.canvas.width||(this.parent.y-b.y-this.scaledHeight)*a.CoreScale>a.Core.canvas.height?!0:!1};a.RenderableSpline.prototype.CommitPoints=function(){for(var b=Number.MAX_VALUE,d=Number.MIN_VALUE,c=b,f=d,e=0;e<this.points.length;++e)this.points[e][0]>d&&(d=this.points[e][0]),this.points[e][0]<b&&(b=this.points[e][0]),this.points[e][1]>f&&(f=this.points[e][1]),this.points[e][1]<c&&(c=this.points[e][1]);this.CleanUp();if(b!=Number.MAX_VALUE){0!=(this.points.length-1)%3&&alert("For curve objects, [Number of points] - 1 MUST be divisible by 3");
this.commited=!0;this.width=Math.floor(d-b);this.height=Math.floor(f-c);this.canvas=document.createElement("canvas");this.canvas.width=this.width;this.canvas.height=this.height;this.scaledWidth=this.width*a.CoreScale;this.scaledHeight=this.height*a.CoreScale;this.x=b;this.y=c;1==a.CoreScale?this.scaledCanvas=this.canvas:(this.scaledCanvas=document.createElement("canvas"),this.scaledCanvas.width=this.scaledWidth,this.scaledCanvas.height=this.scaledHeight);d=this.canvas.getContext("2d");d.save();d.translate(-b,
-c);d.lineWidth=this.strokeWidth;d.strokeStyle=this.strokeColor;d.fillStyle=this.fillColor;d.beginPath();d.moveTo(this.points[0][0],this.points[0][1]);for(e=1;e<=this.points.length-3;e+=3)d.bezierCurveTo(this.points[e][0],this.points[e][1],this.points[e+1][0],this.points[e+1][1],this.points[e+2][0],this.points[e+2][1]);!0===this.fillShape&&(d.closePath(),d.fill());d.stroke();d.restore();if(1!=a.CoreScale){b=d.getImageData(0,0,this.width,this.height).data;c=this.scaledCanvas.getContext("2d");e=c.createImageData(this.scaledWidth,
this.scaledHeight);d=e.data;for(f=0;f<e.height;++f)for(var h=0;h<e.width;++h){var g=4*(f*e.width+h),i=4*(Math.floor(f/a.CoreScale)*this.width+Math.floor(h/a.CoreScale));d[g]=b[i];d[g+1]=b[i+1];d[g+2]=b[i+2];d[g+3]=0<b[i+3]?Math.floor(255*this.alpha):0}c.putImageData(e,0,0)}}}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.GridDraw=function(a){this.parent=a;this.tileSize=1;this.zdepth=1E3};a.GridDraw.prototype.Initialize=function(){a.Core.GetSystem("Graphics").AddRenderable(this)};a.GridDraw.prototype.Uninitialize=function(){a.Core.GetSystem("Graphics").RemoveRenderable(this)};a.GridDraw.prototype.Draw=function(b,d,c){b=a.Core.GetSystem("Graphics");d.beginPath();d.strokeStyle="rgba(200, 200, 200, .6)";for(var f=this.tileSize*a.CoreScale,e=c.x*a.CoreScale%f,c=c.y*a.CoreScale%f,h=(Math.ceil(b.canvas.width/
f)+1)*f,g=(Math.ceil(b.canvas.height/f)+1)*f,i=0;i<b.canvas.width/f+1;++i)d.moveTo(i*f-e,-c-f),d.lineTo(i*f-e,g-c);for(g=0;g<b.canvas.height/f+1;++g)d.moveTo(-e-f,g*f-c),d.lineTo(h-e,g*f-c);d.stroke();d.closePath()}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.LightComposite=function(){this.alpha=0.9;this.zdepth=201};a.LightComposite.prototype.Initialize=function(){a.Core.GetSystem("Graphics").AddRenderable(this)};a.LightComposite.prototype.Uninitialize=function(){a.Core.GetSystem("Graphics").RemoveRenderable(this)};a.LightComposite.prototype.Draw=function(b,d){d.save();var c=a.Core.GetSystem("Lighting").ambientLevel;0>c&&(c=0);1<c&&(c=1);d.globalAlpha=1-c;d.drawImage(a.Core.GetSystem("Lighting").canvas,0,0);d.restore()}})(window.TomatoJS=
window.TomatoJS||{},jQuery);(function(a){a.Light=function(a){this.parent=a;this.red=1;this.blue=this.green=0.9;this.level=1;this.radius=40;this.arc=2*Math.PI;this.angle=this.offsetY=this.offsetX=0;this.active=!0;this.numRays=100;this.notifyTime=1;this.notifyTimer=0;this.zdepth=200;this.tileLayer=0};a.Light.prototype.Initialize=function(){a.Core.GetSystem("Graphics").AddRenderable(this);a.Core.AddEventListener("OnFrameBegin",this)};a.Light.prototype.Uninitialize=function(){a.Core.GetSystem("Graphics").RemoveRenderable(this);
a.Core.RemoveEventListener("OnFrameBegin",this)};a.Light.prototype.OnFrameBegin=function(b){if(this.active&&a.Core.GetSystem("Lighting")){var d=a.Core.GetSystem("TileSystem");if(!d){var c=[this.parent.x+this.offsetX,this.parent.y+this.offsetY];this.notifyTimer+=b;if(this.notifyTimer>this.notifyTime){this.notifyTimer=0;var b=d.GetCollidersInRadius(c[0],c[1],this.radius),f;for(f in b)d.InLineOfSight(d.GetTileMap(this.tileLayer),c[0],c[1],b[f].parent.x,b[f].parent.y,this.angle,this.arc)&&b[f].parent.Invoke("OnEnterLight",
c[0],c[1])}}}};a.Light.prototype.Draw=function(b,d,c){if(this.active&&a.Core.GetSystem("Lighting")){var b=Math.floor(255*this.red),f=Math.floor(255*this.green),e=Math.floor(255*this.blue),h=this.level,g=(this.parent.x-c.x)*a.CoreScale,i=(this.parent.y-c.y)*a.CoreScale;canvas=a.Core.GetSystem("Lighting").canvas;if(!(0>g+this.radius*a.CoreScale||0>i+this.radius*a.CoreScale))if(!(g-this.radius*a.CoreScale>canvas.width||i-this.radius*a.CoreScale>canvas.height)){++a.Core.GetSystem("Lighting").currentLightsOnScreen;
this.parent.GetComponent("TileCollider")&&(this.tileLayer=this.parent.GetComponent("TileCollider").tileLayer);var k=[];if(d=a.Core.GetSystem("TileSystem")){var j=d.GetTileMap(this.tileLayer);if(this.arc==2*Math.PI)for(var l=0;l<this.numRays;++l){var m=this.arc/this.numRays*l,n=this.parent.x+Math.cos(m)*this.radius,m=this.parent.y+Math.sin(m)*this.radius,p={};p[this.parent.id]=!0;p=d.RaycastToPoint(j,this.parent.x,this.parent.y,n,m,!0,p,!0);p.collision?k.push([(p.x-c.x)*a.CoreScale,(p.y-c.y)*a.CoreScale]):
k.push([(n-c.x)*a.CoreScale,(m-c.y)*a.CoreScale])}else{k.push([(this.parent.x+this.offsetX-c.x)*a.CoreScale,(this.parent.y+this.offsetY-c.y)*a.CoreScale]);for(l=0;l<this.numRays;++l)m=this.arc/this.numRays*l+this.angle-this.arc/2,n=this.parent.x+Math.cos(m)*this.radius+this.offsetX,m=this.parent.y+Math.sin(m)*this.radius+this.offsetY,p={},p[this.parent.id]=!0,p=d.RaycastToPoint(j,this.parent.x+this.offsetX,this.parent.y+this.offsetY,n,m,!0,p,!0),p.collision?k.push([(p.x-c.x)*a.CoreScale,(p.y-c.y)*
a.CoreScale]):k.push([(n-c.x)*a.CoreScale,(m-c.y)*a.CoreScale]);k.push([(this.parent.x+this.offsetX-c.x)*a.CoreScale,(this.parent.y+this.offsetY-c.y)*a.CoreScale])}}else if(this.arc==2*Math.PI)for(l=0;l<this.numRays;++l)m=this.arc/this.numRays*l,n=this.parent.x+Math.cos(m)*this.radius,m=this.parent.y+Math.sin(m)*this.radius,k.push([(n-c.x)*a.CoreScale,(m-c.y)*a.CoreScale]);else{k.push([(this.parent.x+this.offsetX-c.x)*a.CoreScale,(this.parent.y+this.offsetY-c.y)*a.CoreScale]);for(l=0;l<this.numRays;++l)m=
this.arc/this.numRays*l+this.angle-this.arc/2,n=this.parent.x+Math.cos(m)*this.radius+this.offsetX,m=this.parent.y+Math.sin(m)*this.radius+this.offsetY,k.push([(n-c.x)*a.CoreScale,(m-c.y)*a.CoreScale]);k.push([(this.parent.x+this.offsetX-c.x)*a.CoreScale,(this.parent.y+this.offsetY-c.y)*a.CoreScale])}d=a.Core.GetSystem("Lighting").context;d.save();d.globalCompositeOperation="destination-out";c=d.createRadialGradient(g,i,this.radius/3*a.CoreScale,g,i,this.radius*a.CoreScale);c.addColorStop(0,"rgba("+
b+", "+f+", "+e+", "+h+")");c.addColorStop(1,"rgba("+b+", "+f+", "+e+", 0)");d.fillStyle=c;d.beginPath();d.moveTo(k[0][0],k[0][1]);for(l=1;l<k.length;++l)d.lineTo(k[l][0],k[l][1]);d.lineTo(k[0][0],k[0][1]);d.fill();d.closePath();d.restore()}}}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.Lighting=function(){this.lightComposite=null;this.numLightsOnScreen=this.currentLightsOnScreen=0;this.ambientLevel=0.5;this.zdepth=100;this.canvas=document.createElement("canvas");this.canvas.width=a.Core.canvas.width;this.canvas.height=a.Core.canvas.height;this.context=this.canvas.getContext("2d")};a.Lighting.prototype.Initialize=function(){this.lightComposite=new a.LightComposite;this.lightComposite.Initialize();a.Core.GetSystem("Graphics").AddRenderable(this)};a.Lighting.prototype.Uninitialize=
function(){this.lightComposite.Uninitialize();this.lightComposite=null;a.Core.GetSystem("Graphics").RemoveRenderable(this)};a.Lighting.prototype.Update=function(){this.numLightsOnScreen=this.currentLightsOnScreen;this.currentLightsOnScreen=0};a.Lighting.prototype.Draw=function(b,d){var c=Math.floor(255*this.red),f=Math.floor(255*this.green),e=Math.floor(255*this.blue),d=a.Core.GetSystem("Lighting").context;d.fillStyle="rgb("+c+", "+f+", "+e+")";d.fillRect(0,0,a.Core.canvas.width,a.Core.canvas.height)}})(window.TomatoJS=
window.TomatoJS||{},jQuery);(function(a){a.Particle=function(a,d,c,f,e,h){this.x=a;this.y=d;this.vy=this.vx=0;this.dir=c;this.speed=f;this.speedDecay=e;this.startLife=this.life=h;this.alpha=1};a.ParticleEmitter=function(a){this.parent=a;this.zdepth=0;this.particles=[];this.spawnTimer=this.elapsedTime=0;this.life=10;this.loop=this.active=!0;this.imageURL="";this.particleImage=null;this.maxParticles=30;this.spawningActive=!0;this.spawnPerSecond=10;this.spawnDirection=this.spawnOffsetYSpread=this.spawnOffsetXSpread=this.spawnOffsetY=
this.spawnOffsetX=0;this.spawnDirectionSpread=Math.PI/4;this.spawnSpeed=5;this.spawnSpeedSpread=2;this.speedDecay=1;this.forceY=this.forceX=this.speedDecaySpread=0;this.alphaKeys=[];this.particleLife=5;this.particleLifeSpread=3;this.collisionEnabled=!1;this.tileLayer=0;this.particleFunction=null};a.ParticleEmitter.prototype.Initialize=function(){this.particleImage=a.Core.resourceManager.GetImage(this.imageURL);a.Core.GetSystem("Graphics").AddRenderable(this);a.Core.AddEventListener("OnFrameBegin",
this)};a.ParticleEmitter.prototype.Uninitialize=function(){a.Core.GetSystem("Graphics").RemoveRenderable(this);a.Core.RemoveEventListener("OnFrameBegin",this)};a.ParticleEmitter.prototype.OnFrameBegin=function(b){if(this.active){this.life-=b;if(this.spawningActive){this.elapsedTime+=b;this.spawnTimer+=b;for(var d=Math.floor(this.spawnTimer/(1/this.spawnPerSecond)),c=0;c<d;++c){var f=this.parent.x+this.spawnOffsetX+Math.random()*this.spawnOffsetXSpread-this.spawnOffsetXSpread/2,e=this.parent.y+this.spawnOffsetY+
Math.random()*this.spawnOffsetYSpread-this.spawnOffsetYSpread/2,h=this.spawnDirection+Math.random()*this.spawnDirectionSpread-this.spawnDirectionSpread/2,g=this.spawnSpeed+Math.random()*this.spawnSpeedSpread-this.spawnSpeedSpread/2,i=this.speedDecay+Math.random()*this.speedDecaySpread-this.speedDecaySpread/2,k=this.particleLife+Math.random()*this.particleLifeSpread-this.particleLifeSpread/2;if(this.particles.length<this.maxParticles){var j=new a.Particle(f,e,h,g,i,k);j.alpha=this.startAlpha;this.particles.push(j)}else if(this.loop){for(j=
0;j<this.particles.length&&0<this.particles[j].life;)++j;j<this.particles.length&&(j=this.particles[j],j.x=f,j.y=e,j.dir=h,j.speed=g,j.speedDecay=i,j.life=k,j.starLife=k,j.alpha=this.startAlpha)}this.spawnTimer=0}}for(c in this.particles)if(j=this.particles[c],!(0>=j.life)){j.x+=Math.cos(j.dir)*j.speed*b;j.y+=Math.sin(j.dir)*j.speed*b;j.x+=j.vx;j.y+=j.vy;j.vx+=this.forceX*b;j.vy+=this.forceY*b;j.speed*=j.speedDecay;d=a.NormalizeInRange(0,j.startLife,j.startLife-j.life);if(0<this.alphaKeys.length){for(f=
e=f=0;f<this.alphaKeys.length&&!(d<this.alphaKeys[f].time);++f);--f;1<this.alphaKeys.length&&(e=f+1);d=a.NormalizeInRange(this.alphaKeys[f].time,this.alphaKeys[e].time,d);j.alpha=a.Lerp(this.alphaKeys[f].val,this.alphaKeys[e].val,d)}this.collisionEnabled&&(d=a.Core.GetSystem("TileSystem").GetTileMap(this.tileLayer),d.GetTileInWorld(j.x,j.y,d.CollisionAttr)==d.SolidTile&&(j.speed=0,j.vx=0,j.vy=0));this.particleFunction&&this.particleFunction(j);j.life-=b}0>=this.life&&!this.loop&&this.parent.Destroy()}};
a.ParticleEmitter.prototype.Draw=function(b,d,c){d.save();for(var f in this.particles)if(b=this.particles[f],!(0>=b.life)){var e=b.x-c.x,h=b.y-c.y;0>e||(0>h||e>a.Core.canvas.width||h>a.Core.canvas.height)||(d.globalAlpha=b.alpha,this.particleImage.Draw(d,b.x-c.x-this.particleImage.width/2,b.y-c.y-this.particleImage.height/2))}d.restore()}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.CoreScale=1;a.Tileset=function(a){this.tileHeight=this.tileWidth=16;this.imageURL=a;this.image=null};a.Tileset.prototype.Initialize=function(){var b=this;this.image=a.Core.resourceManager.GetImage(this.imageURL,function(a){b.tilesX=a.width/b.tileWidth;b.tilesY=a.height/b.tileHeight})};a.Tileset.prototype.DrawTileAtPosition=function(a,d,c,f){this.image.DrawClipped(a,c,f,d%this.tilesX*this.tileWidth,Math.floor(d/this.tilesX)*this.tileHeight,this.tileWidth,this.tileHeight)}})(window.TomatoJS=
window.TomatoJS||{},jQuery);(function(a,b,d){a.TileMap=function(){this.tiles={};this.zdepth=-1;this.visible=!0;this.tile_size=16;this.height=this.width=this.layer=0;this.tilesetPath="";this.tileset=null;this.minTilePos=[0,0];this.maxTilePos=[0,0]};a.TileMap.prototype.Load=function(a){this.zdepth=a.zdepth;this.tile_size=a.tile_size;this.minTilePos=a.minTilePos?a.minTilePos:[0,0];this.maxTilePos=a.maxTilePos?a.maxTilePos:[a.width-1,a.height-1];this.tilesetPath=a.tileset;this.tiles={};for(var b in a.tiles)for(var e=b,d=a.tiles[b].split(" "),
g=this.minTilePos[0],i=this.minTilePos[1],k=0;k<a.tiles[b].length;++k){var j=parseInt(d[k]);++k;for(var l=parseInt(d[k]),m=0;m<j;++m)this.SetTile(g,i,e,l),++i,i>this.maxTilePos[1]&&(++g,i=this.minTilePos[1])}};a.TileMap.prototype.Save=function(){var a={};a.zdepth=this.zdepth;a.tile_size=this.tile_size;a.minTilePos=this.minTilePos;a.maxTilePos=this.maxTilePos;a.tileset=this.tilesetPath;a.tiles={};var b=[this.ImageAttr,this.CollisionAttr,this.ObjectAttr],e;for(e in b){var h=b[e];a.tiles[h]="";for(var g=
"none",i=0,k=this.minTilePos[0];k<this.maxTilePos[0]+1;++k)for(var j=this.minTilePos[1];j<this.maxTilePos[1]+1;++j){var l=-1;this.tiles[k]&&(this.tiles[k][j]&&this.tiles[k][j][h]!=d)&&(l=this.tiles[k][j][h]);g!=l&&"none"!=g?(a.tiles[h]+=i+" ",a.tiles[h]+=g+" ",g=l,i=1):(g=l,++i);k==this.maxTilePos[0]&&j==this.maxTilePos[1]&&(a.tiles[h]+=i+" ",a.tiles[h]+=g+" ")}}return a};a.TileMap.prototype.SetTile=function(a,b,e,d){a=Math.floor(a);b=Math.floor(b);this.tiles[a]||(this.tiles[a]={});this.tiles[a][b]||
(this.tiles[a][b]={});null!=d?(this.tiles[a][b][e]=d,this.minTilePos[0]=Math.min(this.minTilePos[0],a),this.minTilePos[1]=Math.min(this.minTilePos[1],b),this.maxTilePos[0]=Math.max(this.maxTilePos[0],a),this.maxTilePos[1]=Math.max(this.maxTilePos[1],b),this.width=this.maxTilePos[0]-this.minTilePos[0],this.height=this.maxTilePos[1]-this.minTilePos[1]):delete this.tiles[a][b][e]};a.TileMap.prototype.SetTileInWorld=function(a,b,e,d){a=Math.floor(a/this.tile_size);b=Math.floor(b/this.tile_size);this.tiles[a]||
(this.tiles[a]={});this.tiles[a][b]||(this.tiles[a][b]={});null!=d?(this.tiles[a][b][e]=d,this.minTilePos[0]=Math.min(this.minTilePos[0],a),this.minTilePos[1]=Math.min(this.minTilePos[1],b),this.maxTilePos[0]=Math.max(this.maxTilePos[0],a),this.maxTilePos[1]=Math.max(this.maxTilePos[1],b),this.width=this.maxTilePos[0]-this.minTilePos[0],this.height=this.maxTilePos[1]-this.minTilePos[1]):delete this.tiles[a][b][e]};a.TileMap.prototype.GetTile=function(a,b,e){a=Math.floor(a);b=Math.floor(b);if(!this.tiles[a]||
!this.tiles[a][b])return null;a=this.tiles[a][b][e];return!a?null:a};a.TileMap.prototype.GetTileInWorld=function(a,b,e){a=Math.floor(a/this.tile_size);b=Math.floor(b/this.tile_size);if(!this.tiles[a]||!this.tiles[a][b])return null;a=this.tiles[a][b][e];return!a?null:a};a.TileMap.prototype.ClearObjects=function(){for(var a in this.tiles)for(var b in this.tiles[a])delete this.tiles[a][b][this.ObjectAttr]};a.TileMap.prototype.SetTileset=function(b){this.tilesetPath=b;this.tileset=a.Core.resourceManager.GetTileset(b)};
a.TileMap.prototype.Draw=function(b,f,e){!this.tileset&&""!=this.tilesetPath&&(this.tileset=a.Core.resourceManager.GetTileset(this.tilesetPath));if(this.visible){var d=Math.ceil(e.x/this.tile_size),b=Math.ceil((e.x+a.Core.canvas.width)/this.tile_size),g=Math.ceil(e.y/this.tile_size),i=Math.ceil((e.y+a.Core.canvas.height)/this.tile_size);a.Core.editorEnabled&&(f.fillStyle="rgba(255, 0, 0, 0.3)");for(d-=1;d<b;++d)if(this.tiles[d])for(var k=g-1;k<i;++k)if(this.tiles[d][k]){var j=d,l=k,m=this.tiles[j][l][this.ImageAttr];
0<=m&&this.tileset.DrawTileAtPosition(f,m,d*this.tile_size-e.x,k*this.tile_size-e.y);if(a.Core.editorEnabled){var m=d*this.tile_size*a.CoreScale-e.x*a.CoreScale,n=k*this.tile_size*a.CoreScale-e.y*a.CoreScale;this.tiles[j][l][this.CollisionAttr]==this.SolidTile&&f.fillRect(m,n,this.tile_size*a.CoreScale,this.tile_size*a.CoreScale)}}}};a.TileMap.prototype.ImageAttr="image";a.TileMap.prototype.CollisionAttr="collision";a.TileMap.prototype.ObjectAttr="objects";a.TileMap.prototype.EmptyTile=0;a.TileMap.prototype.SolidTile=
1})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b,d){a.TileSystem=function(){this.colliders={};this.tilemaps=[];this.editorObjects={};this.colliderMap=new a.TileMap;this.colliderMap.tile_size=32;this.pendingClear=this.editorEnabled=!1;this.activeTileRight=this.activeTileLeft=this.activeLayer=0;this.activeObject="";this.activeMode="tile";this.dragging=!1;this.dragStartPos=[0,0];this.showActive=!1;this.updateUITimer=0;this.updateUITime=3;this.levelFlags={};a.Core.AddEventListener("OnObjectInitialized",this);a.Core.AddEventListener("OnObjectUninitialized",
this);a.Core.AddEventListener("OnKeyDown",this);var b=this;this.onDragNoOp=function(a){a.stopPropagation();a.preventDefault()};this.onDragDrop=function(f){f.originalEvent&&(f=f.originalEvent);f.stopPropagation();f.preventDefault();var e=f.dataTransfer.files[0].name;if(e.endsWith(".blueprint"))a.Core.resourceManager.GetBlueprint(e)&&(b.activeObject=e,e=a.GetMousePos(f),b.PlaceObject(e.x,e.y));else if(e.endsWith(".tileset")){if(f=a.Core.resourceManager.GetTileset(e))b.tilemaps[b.activeLayer].tilesetPath=
e,b.tilemaps[b.activeLayer].tileset=f,b.SelectLayer(b.activeLayer)}else e.endsWith(".lvl")&&b.LoadLevelFromFile(e)}};a.TileSystem.prototype.EnableEditing=function(){this.editorEnabled=!0;a.Core.GetSystem("Graphics").debugDrawEnabled=!0;this.editor=a.Core.CreateGameObject();this.editor.AddComponent("GridDraw");this.editor.Initialize();a.Core.AddEventListener("OnMouseDown",this);a.Core.AddEventListener("OnMouseMove",this);a.Core.AddEventListener("OnMouseUp",this);a.Core.DispatchEvent("OnEditorToggle",
!0);this.BuildUI();this.editorCamera=a.Core.CreateGameObject();this.editorCamera.AddComponent("EditorController");this.editorCamera.x=a.Core.GetSystem("Graphics").camera.x;this.editorCamera.y=a.Core.GetSystem("Graphics").camera.y;this.editorCamera.Initialize();a.Core.editorEnabled=!0;b("body").css("cursor","crosshair")};a.TileSystem.prototype.DisableEditing=function(){this.editorEnabled=!1;a.Core.GetSystem("Graphics").debugDrawEnabled=!1;this.editor.Destroy();b("#editorui").remove();b("#outlineui").remove();
a.Core.RemoveEventListener("OnMouseDown",this);a.Core.RemoveEventListener("OnMouseMove",this);a.Core.RemoveEventListener("OnMouseUp",this);a.Core.DispatchEvent("OnEditorToggle",!1);this.editorCamera.Destroy();a.Core.editorEnabled=!1;a.Core.showCursor?b("body").css("cursor","auto"):b("body").css("cursor","none");var c=b("#mainCanvas");0<b("#UISystemBody").length&&(c=b("#UISystemBody"));c.unbind("dragenter",this.onDragNoOp);c.unbind("dragexit",this.onDragNoOp);c.unbind("dragover",this.onDragNoOp);c.unbind("drop",
this.onDragDrop)};a.TileSystem.prototype.OnKeyDown=function(c){c==a.Core.input.E&&a.Core.configData.editorEnabled&&(!1==this.editorEnabled?this.EnableEditing():this.DisableEditing());this.editorEnabled&&(c==a.Core.input.G&&(this.selectedObject&&!this.dragging)&&(this.dragging=!0,this.dragStartPos=[this.selectedObject.x,this.selectedObject.y]),c==a.Core.input.BACKSPACE&&this.selectedObject&&(this.dragging=!1,delete this.editorObjects[this.selectedObject.id],this.selectedObject.Destroy(),this.selectedObject=
null,this.UpdateOutlineUI(),this.BuildPropUI()),c==a.Core.input.Q&&("tile"==this.activeMode?b("#objectui").click():b("#tileui").click()))};a.TileSystem.prototype.OnMouseMove=function(c){if(!(c.pageX<b(a.Core.canvas).offset().left||c.pageY<b(a.Core.canvas).offset().top))if(!(c.pageX>b(a.Core.canvas).offset().left+a.Core.canvas.width||c.pageY>b(a.Core.canvas).offset().top+a.Core.canvas.height)){var f=!0;0<b(c.target).parents("#UISystemBody").length&&(f=!1);"UISystemBody"==b(c.target).attr("id")&&(f=
!1);b(c.target).is("canvas")&&(f=!1);if(!f){if("tile"==this.activeMode){var f=a.Core.input.IsDown(a.Core.input.LEFT_MOUSE),e=a.Core.input.IsDown(a.Core.input.RIGHT_MOUSE);f&&this.PlaceTile(c.canvasX,c.canvasY,a.Core.input.LEFT_MOUSE);e&&this.PlaceTile(c.canvasX,c.canvasY,a.Core.input.RIGHT_MOUSE)}this.dragging&&this.selectedObject&&(f=a.Core.GetSystem("Graphics"),this.selectedObject.x=c.canvasX+f.camera.x,this.selectedObject.y=c.canvasY+f.camera.y)}}};a.TileSystem.prototype.OnMouseDown=function(c){if(!(c.pageX<
b(a.Core.canvas).offset().left||c.pageY<b(a.Core.canvas).offset().top))if(!(c.pageX>b(a.Core.canvas).offset().left+a.Core.canvas.width||c.pageY>b(a.Core.canvas).offset().top+a.Core.canvas.height)){var f=!0;0<b(c.target).parents("#UISystemBody").length&&(f=!1);"UISystemBody"==b(c.target).attr("id")&&(f=!1);b(c.target).is("canvas")&&(f=!1);if(!f)if(this.dragging)if(c.which==a.Core.input.LEFT_MOUSE){if(this.dragging=!1,c=this.editorObjects[this.selectedObject.id])c.x=this.selectedObject.x,c.y=this.selectedObject.y}else c.which==
a.Core.input.RIGHT_MOUSE&&(this.dragging=!1,this.selectedObject.x=this.dragStartPos[0],this.selectedObject.y=this.dragStartPos[1]);else"tile"==this.activeMode?this.PlaceTile(c.canvasX,c.canvasY,c.which):"object"==this.activeMode&&(c.which==a.Core.input.LEFT_MOUSE?this.PlaceObject(c.canvasX,c.canvasY):c.which==a.Core.input.RIGHT_MOUSE&&this.SelectObject(c.canvasX,c.canvasY))}};a.TileSystem.prototype.OnMouseUp=function(){};a.TileSystem.prototype.GetLevelFlag=function(a){return this.levelFlags[a]?this.levelFlags[a]:
null};a.TileSystem.prototype.SetLevelFlag=function(a,b){this.levelFlags[a]=b};a.TileSystem.prototype.PlaceTile=function(b,f,e){var d=a.Core.GetSystem("Graphics"),g=this.tilemaps[this.activeLayer],b=b+d.camera.x,f=f+d.camera.y;e==a.Core.input.LEFT_MOUSE?(g.tileset&&g.SetTileInWorld(b,f,g.ImageAttr,this.activeTileLeft),g.SetTileInWorld(b,f,g.CollisionAttr,this.activeCollisionLeft)):e==a.Core.input.RIGHT_MOUSE&&(g.tileset&&g.SetTileInWorld(b,f,g.ImageAttr,this.activeTileRight),g.SetTileInWorld(b,f,g.CollisionAttr,
this.activeCollisionRight))};a.TileSystem.prototype.PlaceObject=function(b,f){if(""!=this.activeObject){var e=a.Core.GetSystem("Graphics"),b=b+e.camera.x,f=f+e.camera.y,e=a.Core.LoadGameObject(this.activeObject);e.x=b;e.y=f;e.GetComponent("TileCollider")&&(e.GetComponent("TileCollider").tileLayer=this.activeLayer);this.editorObjects[e.id]={blueprint:this.activeObject,x:e.x,y:e.y};this.editorObjects[e.id].modifiedData={TileCollider:{tileLayer:this.activeLayer}};this.UpdateOutlineUI()}};a.TileSystem.prototype.SelectObject=
function(c,f){var e=a.Core.GetSystem("Graphics"),c=c+e.camera.x,f=f+e.camera.y;this.selectedObject=null;var e=0,d;for(d in a.Core.game_objects){var g=a.Core.game_objects[d],i=[8,8],k=g.GetComponent("Renderable"),j=g.GetComponent("TileCollider");k?i=[k.width/2,k.height/2]:j&&(i=[j.width/2,j.height/2]);if(a.Vec2ContainedInRect([c,f],[g.x-i[0],g.y-i[1]],[2*i[0],2*i[1]]))if(k){if(k.zdepth>e||!this.selectedObject)e=k.zdepth,this.selectedObject=g}else{this.selectedObject=g;break}}this.BuildPropUI();this.selectedObject&&
(b("#outlineui-load-name").val(this.selectedObject.name),b("#outlineui-load-input").val(this.selectedObject.blueprintName))};a.TileSystem.prototype.GetTileMap=function(a){return this.tilemaps[a]};a.TileSystem.prototype.AddTileMap=function(c){var f=this.tilemaps.length;this.tilemaps.push(c);a.Core.GetSystem("Graphics").AddRenderable(c);this.editorEnabled&&(b("<div class='layerui-select-layer' data-index='"+f+"' id='layerui-select-layer-"+f+"'>"+f+"</div>").appendTo("#layerui-select"),this.SelectCollision(0,
0,1,this.activeCollisionLeft),this.SelectCollision(0,0,3,this.activeCollisionRight),this.SelectTile(0,0,1,this.activeTileLeft),this.SelectTile(0,0,3,this.activeTileRight))};a.TileSystem.prototype.RemoveTileMap=function(c){for(var f=0;f<this.tilemaps.length;++f)if(this.tilemaps[f]==c){this.tilemaps.splice(f,1);a.Core.GetSystem("Graphics").RemoveRenderable(c);this.editorEnabled&&b("#layerui-select-layer-"+f).remove();break}this.editorEnabled&&(b("#layerui-select").children().each(function(a){b(this).attr("id",
"layerui-select-layer-"+a);b(this).attr("data-index",a);b(this).text(a)}),0<this.tilemaps.length&&(this.SelectLayer(0),this.SelectCollision(0,0,1,this.activeCollisionLeft),this.SelectCollision(0,0,3,this.activeCollisionRight),this.SelectTile(0,0,1,this.activeTileLeft),this.SelectTile(0,0,3,this.activeTileRight)))};a.TileSystem.prototype.OnObjectInitialized=function(a){var b=a.GetComponent("TileCollider");b&&(this.colliders[a.id]=b)};a.TileSystem.prototype.OnObjectUninitialized=function(a){a.GetComponent("TileCollider")&&
delete this.colliders[a.id]};a.TileSystem.prototype.Update=function(b){0==this.tilemaps.length&&(this.AddTileMap(new a.TileMap),this.editorEnabled&&this.SelectLayer(0));this.colliderMap.ClearObjects();for(var f in this.colliders){var e=this.colliders[f],d=this.tilemaps[e.tileLayer];if(e.wrap){for(var g=e.parent.x,i=e.parent.y;0>e.parent.x;)e.parent.x+=d.width*d.tile_size;for(;0>e.parent.y;)e.parent.y+=d.height*d.tile_size;for(;e.parent.x>=d.width*d.tile_size;)e.parent.x-=d.height*d.tile_size;for(;e.parent.y>=
d.height*d.tile_size;)e.parent.y-=d.height*d.tile_size;(g!=e.parent.x||i!=e.parent.y)&&e.parent.Invoke("OnWrapped")}e.RegisterTiles(this.colliderMap);e.CheckCollision(d)}for(f in this.colliders)e=this.colliders[f],e.CheckObjectCollision(this.colliderMap);if(this.editorEnabled&&(this.UpdateUI(b),this.editor.GetComponent("GridDraw").tileSize=this.tilemaps[0].tile_size,b=this.selectedObject))f=[8,8],e=b.GetComponent("Renderable"),d=b.GetComponent("TileCollider"),e?f=[e.width,e.height]:d&&(f=[d.width,
d.height]),a.Core.GetSystem("Graphics").AddDebugBox(b.x-f[0]/2,b.y-f[1]/2,f[0],f[1],"rgb(50, 255, 50)")};a.TileSystem.prototype.LoadLevelFromFile=function(b){b=a.Core.resourceManager.GetLevel(b);this.LoadLevel(b)};a.TileSystem.prototype.LoadLevel=function(b){this.ClearLevel();b.flags&&(this.levelFlags=b.flags);for(var d in b.tilemaps){var e=b.tilemaps[d],h=this.tilemaps[d]?this.tilemaps[d]:new a.TileMap;h.layer=this.tilemaps.length;h.Load(e);this.AddTileMap(h)}this.editorObjects={};for(d in b.objects){e=
b.objects[d];h=null;h=e.blueprint&&e.name?a.Core.LoadGameObjectNamed(e.blueprint,e.name,!0):e.blueprint?a.Core.LoadGameObject(e.blueprint,!0):a.Core.CreateGameObject();h.x=e.x;h.y=e.y;this.editorObjects[h.id]=e;e.name&&h.SetName(e.name);for(var g in e.flags)h.flags[g]=e.flags[g];for(var i in e.modifiedData)for(var k in e.modifiedData[i]){var j=h.GetComponent(i);j&&(j[k]=e.modifiedData[i][k])}h.Initialize()}this.editorEnabled&&this.BuildPropUI()};a.TileSystem.prototype.SaveLevel=function(){var a={tilemaps:[]};
a.flags=this.levelFlags;for(var b in this.tilemaps)a.tilemaps.push(this.tilemaps[b].Save());a.objects=this.editorObjects;return a};a.TileSystem.prototype.ClearLevel=function(){for(;0<this.tilemaps.length;)this.RemoveTileMap(this.tilemaps[0]);for(var b in this.editorObjects){var d=a.Core.GetGameObjectById(b);d&&d.Destroy()}this.editorObjects={};this.levelFlags={}};a.TileSystem.prototype.GetCollidersInRadius=function(a,b,e){for(var d=this.colliderMap,g=Math.floor((b-e)/d.tile_size),i=Math.floor((a+
e)/d.tile_size),k=Math.floor((b+e)/d.tile_size),j={},a=Math.floor((a-e)/d.tile_size);a<=i;++a)for(b=g;b<=k;++b){var e=d.GetTile(a,b,d.ObjectAttr),l;for(l in e)j[e[l].parent.id]=e[l]}return j};a.TileSystem.prototype.RaycastToPoint=function(a,b,e,d,g,i,k,j){for(var l=Math.abs(d-b),m=Math.abs(g-e),n=b<d?1:-1,p=e<g?1:-1,q=l-m;(0.01<Math.abs(d-b)||0.01<Math.abs(g-e))&&!(0<n&&b>d)&&!(0>n&&b<d)&&!(0<p&&e>g)&&!(0>p&&e<g);){if(i){var r=this.colliderMap.GetTileInWorld(b,e,a.ObjectAttr),t;for(t in r){var s=
r[t];if(!k||!k[s.parent.id])if((!j||s.stopsLight)&&s.CheckPointInside(b,e))return{collision:!0,x:b,y:e,collider:s}}}if(a.GetTileInWorld(b,e,a.CollisionAttr)==a.SolidTile)return{collision:!0,x:b,y:e};r=2*q;r>-m&&(q-=m,b+=n);r<l&&(q+=l,e+=p)}return{collision:!1,x:b,y:e}};a.TileSystem.prototype.InLineOfSight=function(b,d,e,h,g,i,k){var j=Math.atan2(g-e,h-d),l=Math.cos(j),j=Math.sin(j);Math.cos(i);Math.sin(i);var m=Math.cos(i+k/2),n=Math.sin(i+k/2),p=Math.cos(i-k/2),i=Math.sin(i-k/2),q=a.Core.GetSystem("Graphics");
q.AddDebugBox(h,g,3,3);q.AddDebugLine(d,e,d+40*m,e+40*n);q.AddDebugLine(d,e,d+40*p,e+40*i);m=Math.acos(m*l+n*j);l=Math.acos(p*l+i*j);return 1E-4<Math.abs(k-m-l)||!0==this.RaycastToPoint(b,d,e,h,g,!0,{},!0).collision?!1:!0};a.TileSystem.prototype.UpdateUI=function(a){this.SelectCollision(0,0,1,this.activeCollisionLeft);this.SelectCollision(0,0,3,this.activeCollisionRight);this.SelectTile(0,0,1,this.activeTileLeft);this.SelectTile(0,0,3,this.activeTileRight);this.updateUITimer+=a;this.updateUITimer>=
this.updateUITime&&(this.updateUITimer=0,this.UpdateOutlineUI())};a.TileSystem.prototype.ToggleShowActive=function(){(this.showActive=!this.showActive)?b("#layerui-showactive").text("Show All Layers"):b("#layerui-showactive").text("Show Only Selected");for(var a in this.tilemaps)this.showActive&&a!=this.activeLayer?this.tilemaps[a].visible=!1:this.showActive||(this.tilemaps[a].visible=!0)};a.TileSystem.prototype.SelectLayer=function(c){this.showActive&&this.tilemaps.length>this.activeLayer&&(this.tilemaps[this.activeLayer].visible=
!1);b("#layerui-select-layer-"+this.activeLayer).text(this.activeLayer);this.activeLayer=c;b("#layerui-select-layer-"+c).text(c+" <--");0<this.tilemaps.length&&(this.tilemaps[this.activeLayer].visible=!0,c=this.tilemaps[this.activeLayer].tileset,!c&&""!=this.tilemaps[this.activeLayer].tilesetPath&&(c=a.Core.resourceManager.GetTileset(this.tilemaps[this.activeLayer].tilesetPath)),c?(b("#tileui-img").attr("src",a.Core.configData.imagePath+c.imageURL),b("#tileui-img").css("display","block")):b("#tileui-img").css("display",
"none"),b("#layerui-tileset-path").val(this.tilemaps[this.activeLayer].tilesetPath),b("#layerui-tileset-zdepth").val(this.tilemaps[this.activeLayer].zdepth));this.SelectCollision(0,0,1,this.activeCollisionLeft);this.SelectCollision(0,0,3,this.activeCollisionRight);this.SelectTile(0,0,1,this.activeTileLeft);this.SelectTile(0,0,3,this.activeTileRight)};a.TileSystem.prototype.SelectTile=function(c,d,e,h){if(""!=this.tilemaps[this.activeLayer].tilesetPath){var g=a.Core.resourceManager.GetTileset(this.tilemaps[this.activeLayer].tilesetPath);
h&&(c=h%g.tilesX,d=Math.floor(h/g.tilesX));b("#tileui-img").attr("src",g.image.url);var h=c*g.tileWidth,i=d*g.tileHeight,k=h+g.tileWidth,j=i+g.tileHeight;1==e?(this.activeTileLeft=c+d*g.tilesX,b("#tileui-select-left").attr("src",g.image.url),b("#tileui-select-left").css("margin-left",-h+"px"),b("#tileui-select-left").css("margin-top",-i+"px"),b("#tileui-select-left").css("margin-right",k-g.image.width+"px"),b("#tileui-select-left").css("margin-bottom",j-g.image.height+"px")):3==e&&(this.activeTileRight=
c+d*g.tilesX,b("#tileui-select-right").css("margin-left",-h+"px"),b("#tileui-select-right").attr("src",g.image.url),b("#tileui-select-right").css("margin-top",-i+"px"),b("#tileui-select-right").css("margin-right",k-g.image.width+"px"),b("#tileui-select-right").css("margin-bottom",j-g.image.height+"px"));b(".editorui-selectbox").css("width",2*g.tileWidth+4+"px");b(".editorui-selectbox").css("height",2*g.tileHeight+4+"px")}};a.TileSystem.prototype.SelectCollision=function(c,d,e,h){var g=a.Core.resourceManager.GetTileset("Collision.json");
h&&(c=h%g.tilesX,d=Math.floor(h/g.tilesX));b("#collisionui-img").attr("src",g.image.url);var h=c*g.tileWidth,i=d*g.tileHeight,k=h+g.tileWidth,j=i+g.tileHeight;1==e?(this.activeCollisionLeft=c+d*g.tilesX,b("#collisionui-select-left").attr("src",g.image.url),b("#collisionui-select-left").css("margin-left",-h+"px"),b("#collisionui-select-left").css("margin-top",-i+"px"),b("#collisionui-select-left").css("margin-right",k-g.image.width+"px"),b("#collisionui-select-left").css("margin-bottom",j-g.image.height+
"px")):3==e&&(this.activeCollisionRight=c+d*g.tilesX,b("#collisionui-select-right").attr("src",g.image.url),b("#collisionui-select-right").css("margin-left",-h+"px"),b("#collisionui-select-right").css("margin-top",-i+"px"),b("#collisionui-select-right").css("margin-right",k-g.image.width+"px"),b("#collisionui-select-right").css("margin-bottom",j-g.image.height+"px"));b(".editorui-selectbox").css("width",2*g.tileWidth+4+"px");b(".editorui-selectbox").css("height",2*g.tileHeight+4+"px")};a.TileSystem.prototype.BuildUI=
function(){b("#editorui").remove();b("<div id='editorui'></div>").appendTo("body");this.BuidLayerUI();this.BuildFileUI();this.BuildTileUI();this.BuidCollisionUI();this.BuildObjectUI();this.BuildPropUI();this.BuildOutlineUI();this.BuildDragDropUI();b("#tileui").click()};a.TileSystem.prototype.BuidLayerUI=function(){b("#layerui").remove();var c;c="<div id='layerui'><div class='editorui-padding'>Layers</div><div id='layerui-select'>";for(var d in this.tilemaps)c+="<div class='layerui-select-layer' data-index='"+
d+"' id='layerui-select-layer-"+d+"'>"+d+"</div>";c+="</div>";c+="<a class='editorui-button' id='layerui-add'>Add Layer</a>";c+="<a class='editorui-button' id='layerui-remove'>Remove Layer</a>";c+="<a class='editorui-button' id='layerui-clear'>Remove All Layers</a>";c+="<a class='editorui-button' id='layerui-showactive'>Show Only Selected</a>";c+="<div class='editorui-padding'>Tileset <input class='editorui-input' id='layerui-tileset-path'></input></div>";c+="<div class='editorui-padding'>Z-Depth <input class='editorui-input' id='layerui-tileset-zdepth'></input></div>";
c+="</div>";b(c).appendTo("#editorui");b("#layerui-select-layer-"+this.activeLayer).text(this.activeLayer+" <--");b("#layerui-tileset-path").val(this.tilemaps[this.activeLayer].tilesetPath);b("#layerui-tileset-zdepth").val(this.tilemaps[this.activeLayer].zdepth);var e=this;b("#layerui-select").bind("click",function(a){b(a.target).attr("data-index")&&(a=parseInt(b(a.target).attr("data-index")),e.SelectLayer(a))});b("#layerui-add").bind("click",function(){e.AddTileMap(new a.TileMap)});b("#layerui-remove").bind("click",
function(){e.RemoveTileMap(e.tilemaps[e.activeLayer])});b("#layerui-clear").bind("click",function(){e.ClearLevel()});b("#layerui-showactive").bind("click",function(){e.ToggleShowActive()});b("#layerui-tileset-path").change(function(){e.tilemaps[e.activeLayer].tilesetPath=b(this).val();if(""!=e.tilemaps[e.activeLayer].tilesetPath){var c=a.Core.resourceManager.GetTileset(e.tilemaps[e.activeLayer].tilesetPath);c&&(b("#tileui-img").attr("src",a.Core.configData.imagePath+c.imageURL),b("#tileui-img").css("display",
"block"))}});b("#layerui-tileset-zdepth").change(function(){e.tilemaps[e.activeLayer].zdepth=parseInt(b(this).val());a.Core.GetSystem("Graphics").SortEverything()})};a.TileSystem.prototype.BuildFileUI=function(){b("#fileui").remove();var c;c="<div class='editorui-padding' id='fileui'><div>File</div><div>Name <input class='editorui-input' id='fileui-name'></input></div>";c+="<a class='editorui-button' id='fileui-save'>Save</a>";c+="<a class='editorui-button' id='fileui-load'>Load</a>";c+="</div>";
b(c).appendTo("#editorui");var d=this;b("#fileui-save").bind("click",function(){var e=d.SaveLevel(),e=JSON.stringify(e),c=b("#fileui-name").val();a.Core.fileManager.WriteFile("res/levels/"+c,e)});b("#fileui-load").bind("click",function(){var a=b("#fileui-name").val();d.LoadLevelFromFile(a)})};a.TileSystem.prototype.BuildTileUI=function(){b("#tileui").remove();var c;c="<div id='tileui'><div>Tiles</div><img id='tileui-img' />";c+="<div class='editorui-selectbox'>";c+="<div class='editorui-clipcontainer'><img id='tileui-select-left' /></div>";
c+="<div class='editorui-clipcontainer'><img id='tileui-select-right' /></div>";c+="</div>";c+="</div>";b(c).appendTo("#editorui");""!=this.tilemaps[this.activeLayer].tilesetPath&&(c=a.Core.resourceManager.GetTileset(this.tilemaps[this.activeLayer].tilesetPath))&&b("#tileui-img").attr("src",a.Core.configData.imagePath+c.imageURL);this.SelectTile(1,0,1);this.SelectTile(0,0,3);var d=this;b("#tileui").bind("click",function(){d.activeMode="tile";b(this).removeClass("panel-inactive");b(this).addClass("panel-active");
b("#collisionui").removeClass("panel-inactive");b("#collisionui").addClass("panel-active");b("#objectui").removeClass("panel-active");b("#objectui").addClass("panel-inactive")});b("#tileui-img").bind("mousedown",function(e){b("#tileui").click();if(""!=d.tilemaps[d.activeLayer].tilesetPath){var c=a.Core.resourceManager.GetTileset(d.tilemaps[d.activeLayer].tilesetPath);d.SelectTile(Math.floor(e.offsetX/c.tileWidth),Math.floor(e.offsetY/c.tileHeight),e.which)}})};a.TileSystem.prototype.BuidCollisionUI=
function(){b("#collisionui").remove();var c;c="<div id='collisionui'><div>Collision</div><img id='collisionui-img' />";c+="<div class='editorui-selectbox'>";c+="<div class='editorui-clipcontainer'><img id='collisionui-select-left' /></div>";c+="<div class='editorui-clipcontainer'><img id='collisionui-select-right' /></div>";c+="</div>";c+="</div>";b(c).appendTo("#editorui");(c=a.Core.resourceManager.GetTileset("Collision.json"))&&b("#collisionui-img").attr("src",a.Core.configData.imagePath+c.imageURL);
this.SelectCollision(1,0,1);this.SelectCollision(0,0,3);var d=this;b("#collisionui").bind("click",function(){d.activeMode="tile";b(this).removeClass("panel-inactive");b(this).addClass("panel-active");b("#tileui").removeClass("panel-inactive");b("#tileui").addClass("panel-active");b("#objectui").removeClass("panel-active");b("#objectui").addClass("panel-inactive")});b("#collisionui-img").bind("mousedown",function(b){var c=a.Core.resourceManager.GetTileset("Collision.json");d.SelectCollision(Math.floor(b.offsetX/
c.tileWidth),Math.floor(b.offsetY/c.tileHeight),b.which)})};a.TileSystem.prototype.BuildObjectUI=function(){b("#objectui").remove();var c;c="<div id='objectui'><div class='editorui-padding'>Objects</div><div class='editorui-padding' id='objectui-selection'>No selection</div>";c+="<div class='editorui-padding' id='objectui-objects'>";var d=a.Core.fileManager.OpenFile(a.Core.configData.blueprintPath+"List.json").GetJSONObject(),e;for(e in d){var h=a.Core.GetBlueprint(d[e]);h.thumb&&(c+="<img data-bp='"+
d[e]+"' class='objectui-object' id='objectui-object-'"+e+"' src='"+a.Core.configData.imagePath+h.thumb+"' />")}c+="</div>";c+="</div>";b(c).appendTo("#editorui");var g=this;b("#objectui").bind("click",function(){g.activeMode="object";b(this).removeClass("panel-inactive");b(this).addClass("panel-active");b("#tileui").removeClass("panel-active");b("#tileui").addClass("panel-inactive");b("#collisionui").removeClass("panel-active");b("#collisionui").addClass("panel-inactive")});b(".objectui-object").bind("click",
function(){g.activeObject=b(this).attr("data-bp");b(".objectui-object").removeClass("objectui-object-selected");b(this).addClass("objectui-object-selected");b("#objectui-selection").text(g.activeObject)})};a.TileSystem.prototype.BuildPropUI=function(){function a(){var e=b(this).attr("data-flag"),c=b(this).val();if(k.selectedObject){k.selectedObject.flags[e]&&k.selectedObject.flags[e].toFixed&&(c=parseFloat(c));k.selectedObject.flags[e]=c;var d=k.editorObjects[k.selectedObject.id];d&&(d.flags||(d.flags=
{}),d.flags[e]=c)}else k.levelFlags[e]&&k.levelFlags[e].toFixed&&(c=parseFloat(c)),k.levelFlags[e]=c}b("#propui").remove();var f="<div id='propui'>",f=this.selectedObject?f+"<div class='editorui-padding'>Flags (Object)</div>":f+"<div class='editorui-padding'>Flags (Level)</div>",f=f+"<div class='editorui-padding' id='propui-flags'><input class='editorui-input' id='propui-addflag-name' />",f=f+"<a class='editorui-button' id='propui-addflag'>Add Flag</a>",f=f+"<a class='editorui-button' id='propui-levelflags'>Level Flags</a>";
if(this.selectedObject)for(var e in this.selectedObject.flags)f+="<div>"+e+"</div>",f+="<input data-flag='"+e+"' class='editorui-input propui-flag' id='propui-flag-"+e+"' />";else for(e in this.levelFlags)f+="<div>"+e+"</div>",f+="<input data-flag='"+e+"' class='editorui-input propui-flag' id='propui-flag-"+e+"' />";f+="</div>";f+="<div class='editorui-padding'>Properties</div>";if(this.selectedObject)for(var h in this.selectedObject.components){var f=f+("<div class='editorui-padding propui-component'>"+
h+"</div>"),f=f+"<div class='editorui-padding'>",g=this.selectedObject.components[h],i;for(i in g)if(null!=g[i]&&g[i]!=d&&(g[i].substring||g[i].toFixed||!1===g[i]||!0===g[i]))f+="<div>"+i+"</div>",f+="<input data-comp='"+h+"' data-prop='"+i+"' class='editorui-input propui-prop' id='propui-input-"+h+"-"+i+"' />";f+="</div>"}f+="</div>";b(f).appendTo("#editorui");if(this.selectedObject){for(e in this.selectedObject.flags)b("#propui-flag-"+e).val(this.selectedObject.flags[e]);for(h in this.selectedObject.components)for(i in g=
this.selectedObject.components[h],g)b("#propui-input-"+h+"-"+i).val(g[i])}else for(e in this.levelFlags)b("#propui-flag-"+e).val(this.levelFlags[e]);var k=this;b("#propui-addflag").bind("click",function(){var e=b("#propui-addflag-name").val();k.selectedObject&&""!=e&&!k.selectedObject.flags[e]?(k.selectedObject.flags[e]=0,b("#propui-flags").append("<div>"+e+"</div>"),b("#propui-flags").append("<input data-flag='"+e+"' class='editorui-input propui-flag' id='propui-flag-"+e+"' />"),b("#propui-flag-"+
e).val(k.selectedObject.flags[e]),b("#propui-flag-"+e).bind("change",a)):""!=e&&(!k.levelFlags[e]&&!k.selectedObject)&&(b("#propui-flags").append("<div>"+e+"</div>"),b("#propui-flags").append("<input data-flag='"+e+"' class='editorui-input propui-flag' id='propui-flag-"+e+"' />"),b("#propui-flag-"+e).val(k.levelFlags[e]),b("#propui-flag-"+e).bind("change",a))});b("#propui-levelflags").bind("click",function(){k.SelectObject(-99E4,-999E4)});b(".propui-flag").bind("change",a);b(".propui-prop").bind("change",
function(){var a=b(this).attr("data-comp"),e=b(this).attr("data-prop"),c=b(this).val();k.selectedObject.components[a][e].toFixed&&(c=parseFloat(b(this).val()));k.selectedObject.components[a][e]=c;k.selectedObject.Invoke("OnEdited");var d=k.editorObjects[k.selectedObject.id];d&&(d.modifiedData||(d.modifiedData={}),d.modifiedData[a]||(d.modifiedData[a]={}),d.modifiedData[a][e]=c)})};a.TileSystem.prototype.UpdateOutlineUI=function(){b("#outlineui-named").empty();b("#outlineui-all").empty();for(var c in a.Core.namedObjects){var d=
"<a data-name='"+c+"' class='editorui-button outlineui-name' id='outlineui-name-"+c+"'>"+c+"</a>";b("#outlineui-named").append(d)}for(c in a.Core.game_objects)d=(d=a.Core.game_objects[c].blueprintName)?d.substring(0,d.lastIndexOf(".")):"No Blueprint",d="<a data-id='"+c+"' class='editorui-button outlineui-id' id='outlineui-id-"+c+"'>Object "+c+" ("+d+")</a>",b("#outlineui-all").append(d);var e=this;b(".outlineui-name").bind("click",function(){var c=b(this).attr("data-name");e.selectedObject=a.Core.GetGameObjectByName(c);
e.BuildPropUI();b("#objectui").click();e.selectedObject&&(b("#outlineui-load-name").val(e.selectedObject.name),b("#outlineui-load-input").val(e.selectedObject.blueprintName))});b(".outlineui-id").bind("click",function(){var c=b(this).attr("data-id");e.selectedObject=a.Core.GetGameObjectById(c);e.BuildPropUI();b("#objectui").click();e.selectedObject&&(b("#outlineui-load-name").val(e.selectedObject.name),b("#outlineui-load-input").val(e.selectedObject.blueprintName))})};a.TileSystem.prototype.BuildOutlineUI=
function(){b("#outlineui").remove();var c;c="<div id='outlineui'><div class='editorui-padding'>Game Objects</div><div class='editorui-padding'>";c+="<div>Name<input class='editorui-input' id='outlineui-load-name' /></div>";c+="<div>Blueprint<input class='editorui-input' id='outlineui-load-input' /></div>";c+="<a class='editorui-button' id='outlineui-load'>Load Object</a>";c+="</div>";c+="<div class='editorui-padding'>Named Objects</div>";c+="<div class='editorui-padding' id='outlineui-named'></div>";
c+="<div class='editorui-padding'>All Objects</div>";c+="<div class='editorui-padding' id='outlineui-all'></div>";c+="</div>";b(c).appendTo("body");this.UpdateOutlineUI();var d=this;b("#outlineui-load-name").bind("change",function(){if(d.selectedObject){d.selectedObject.SetName(b(this).val());var a=d.editorObjects[d.selectedObject.id];a&&(a.name=b(this).val(),d.UpdateOutlineUI())}});b("#outlineui-load-input").bind("change",function(){if(d.selectedObject&&""!=b(this).val()){var e=d.selectedObject,
c=e.GetComponent("TileCollider")?e.GetComponent("TileCollider").tileLayer:d.activeLayer,g=a.Core.LoadGameObject(b(this).val());g.x=e.x;g.y=e.y;""!=e.name&&g.SetName(e.name);d.dragging=!1;delete d.editorObjects[d.selectedObject.id];d.selectedObject.Destroy();e=d.editorObjects[d.selectedObject.id];d.selectedObject=null;e&&(""!=g.name&&(d.editorObjects[g.id].name=g.name),d.editorObjects[g.id]={blueprint:b(this).val(),x:g.x,y:g.y},d.editorObjects[g.id].modifiedData={TileCollider:{tileLayer:c}})}});b("#outlineui-load").bind("click",
function(){var e=b("#outlineui-load-name").val(),c=b("#outlineui-load-input").val(),g=null;""!=c?(g=""!=e&&e?a.Core.LoadGameObjectNamed(c,e):a.Core.LoadGameObject(c),d.editorObjects[g.id]={blueprint:c,x:g.x,y:g.y},d.editorObjects[g.id].modifiedData={TileCollider:{tileLayer:d.activeLayer}},e&&(d.editorObjects[g.id].name=e)):""!=e&&e&&(g=a.Core.CreateGameObject(),g.SetName(e),g.Initialize(),d.editorObjects[g.id]={x:g.x,y:g.y,name:e})})};a.TileSystem.prototype.BuildDragDropUI=function(){var a=b("#mainCanvas");
0<b("#UISystemBody").length&&(a=b("#UISystemBody"));a.bind("dragenter",this.onDragNoOp);a.bind("dragexit",this.onDragNoOp);a.bind("dragover",this.onDragNoOp);a.bind("drop",this.onDragDrop)}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.TileCollider=function(a){this.parent=a;this.height=this.width=0;this.wrap=this.staticCollision=this.grounded=!1;this.tileLayer=0;this.stopsLight=!1;this.offsetY=this.offsetX=0;this.hotspots=[];for(a=0;4>a;++a)this.hotspots.push({});this.hotspots[0].x=-0.5;this.hotspots[0].y=-0.5;this.hotspots[1].x=0.5;this.hotspots[1].y=-0.5;this.hotspots[2].x=0.5;this.hotspots[2].y=0.5;this.hotspots[3].x=-0.5;this.hotspots[3].y=0.5};a.TileCollider.prototype.GetCenterPos=function(){return[this.parent.x-
this.offsetX,this.parent.y-this.offsetY]};a.TileCollider.prototype.GetTile=function(b,d,c){var f=a.Core.GetSystem("TileSystem").GetTileMap(this.tileLayer);return f.GetTile(Math.floor((this.parent.x-this.offsetX)/f.tile_size)+b,Math.floor((this.parent.y-this.offsetY)/f.tile_size)+d,c)};a.TileCollider.prototype.GetTileInWorld=function(b,d,c){return a.Core.GetSystem("TileSystem").GetTileMap(this.tileLayer).GetTileInWorld(this.parent.x-this.offsetX+b,this.parent.y-this.offsetY+d,c)};a.TileCollider.prototype.GetCollidersInRadius=
function(b){return a.Core.GetSystem("TileSystem").GetCollidersInRadius(this.parent.x-this.offsetX,this.parent.y-this.offsetY,b)};a.TileCollider.prototype.GetTileMap=function(){return a.Core.GetSystem("TileSystem").GetTileMap(this.tileLayer)};a.TileCollider.prototype.GetInhabitedTiles=function(a){for(var d=[],c=Math.floor((this.parent.y-this.offsetY+this.hotspots[0].y*this.height)/a.tile_size),f=Math.floor((this.parent.x-this.offsetX+this.hotspots[1].x*this.width)/a.tile_size),e=Math.floor((this.parent.y-
this.offsetY+this.hotspots[2].y*this.height)/a.tile_size),a=Math.floor((this.parent.x-this.offsetX+this.hotspots[0].x*this.width)/a.tile_size);a<=f;++a)for(var h=c;h<=e;++h)d.push({x:a,y:h});return d};a.TileCollider.prototype.RegisterTiles=function(a){var d=this.GetInhabitedTiles(a),c;for(c in d){var f=d[c],e=a.GetTile(f.x,f.y,a.ObjectAttr);e?e[this.parent.id]=this:(e={},e[this.parent.id]=this,a.SetTile(f.x,f.y,a.ObjectAttr,e))}};a.TileCollider.prototype.CheckObjectCollision=function(a){var d=this.GetInhabitedTiles(a),
c;for(c in d){var f=d[c],f=a.GetTile(f.x,f.y,a.ObjectAttr),e;for(e in f){var h=f[e];h.parent.id!=this.parent.id&&this.CollideWithObject(h)&&this.parent.Invoke("OnCollide",h.parent)}}};a.TileCollider.prototype.CollideWithObject=function(a){if(this.parent.x-this.offsetX-this.width/2>a.parent.x-a.offsetX+a.width/2||this.parent.y-this.offsetY-this.height/2>a.parent.y-a.offsetY+a.height/2||this.parent.x-this.offsetX+this.width/2<a.parent.x-a.offsetX-a.width/2||this.parent.y-this.offsetY+this.height/2<
a.parent.y-a.offsetY-a.height/2)return!1;a.staticCollision&&!this.staticCollision&&this.ResolveSAT([a.parent.x-a.offsetX,a.parent.y-a.offsetY],[a.width,a.height]);return!0};a.TileCollider.prototype.GetRect=function(){return[this.parent.x-this.offsetX,this.parent.y-this.offsetY,this.parent.x-this.offsetX+this.width/2,this.parent.y-this.offsetY+this.height/2]};a.TileCollider.prototype.CheckPointInside=function(a,d){return a<this.parent.x-this.offsetX-this.width/2||d<this.parent.y-this.offsetY-this.height/
2||a>this.parent.x-this.offsetX+this.width/2||d>this.parent.y-this.offsetY+this.height/2?!1:!0};a.TileCollider.prototype.ResolveSAT=function(a,d){var c=0,f=0,c=this.parent.x-this.offsetX,f=this.parent.y-this.offsetY,c=c<a[0]?c+this.width/2-(a[0]-d[0]/2):c-this.width/2-(a[0]+d[0]/2),f=f<a[1]?f+this.height/2-(a[1]-d[1]/2):f-this.height/2-(a[1]+d[1]/2);Math.abs(c)<Math.abs(f)?this.parent.x-=c:this.parent.y-=f};a.TileCollider.prototype.CheckCollision=function(b){this.grounded=!1;var d=this.GetInhabitedTiles(b),
c=a.Core.GetSystem("Graphics"),f=this.parent.GetComponent("RigidBody"),e;for(e in d){var h=d[e];c.AddDebugBox(h.x*b.tile_size,h.y*b.tile_size,b.tile_size,b.tile_size);if(b.GetTile(h.x,h.y,b.CollisionAttr)==b.SolidTile){var g=0,i=0,g=this.parent.x-this.offsetX,i=this.parent.y-this.offsetY,k=h.x*b.tile_size+b.tile_size/2,j=h.y*b.tile_size+b.tile_size/2,g=g<k?g+this.width/2-(k-b.tile_size/2):g-this.width/2-(k+b.tile_size/2),i=i<j?i+this.height/2-(j-b.tile_size/2):i-this.height/2-(j+b.tile_size/2);Math.abs(g)<
Math.abs(i)?!(0<g&&b.GetTile(h.x-1,h.y,b.CollisionAttr)==b.SolidTile)&&!(0>g&&b.GetTile(h.x+1,h.y,b.CollisionAttr)==b.SolidTile)&&(this.parent.x-=g):!(0<i&&b.GetTile(h.x,h.y-1,b.CollisionAttr)==b.SolidTile)&&!(0>i&&b.GetTile(h.x,h.y+1,b.CollisionAttr)==b.SolidTile)&&(this.parent.y-=i,0<i?(this.grounded=!0,f&&0<f.velocityY&&(f.velocityY=0)):f&&0>f.velocityY&&(f.velocityY=0))}}c.AddDebugBox(this.parent.x-this.offsetX-this.width/2,this.parent.y-this.offsetY-this.height/2,this.width,this.height)}})(window.TomatoJS=
window.TomatoJS||{},jQuery);(function(a){a.UIText=function(){this.text=""};a.UIText.prototype.Initialize=function(){this.parent.GetGlobalPosition();this.parent.html.text(this.text)};a.UIText.prototype.Uninitialize=function(){}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b){a.UIImage=function(){this.imageURL="core/tomato1.png"};a.UIImage.prototype.Initialize=function(){var d=this;this.htmlImage=b("<img src='"+a.Core.configData.imagePath+this.imageURL+"'></img>");this.parent.html.append(this.htmlImage);this.htmlImage.load(function(){d.htmlImage.css("width",parseFloat(d.htmlImage.css("width"))/a.CoreScale)})};a.UIImage.prototype.Uninitialize=function(){}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.UIWindow=function(){};a.UIWindow.prototype.Initialize=function(){this.parent.GetGlobalPosition()};a.UIWindow.prototype.Uninitialize=function(){}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b){a.UIElement=function(a){this.ui=this.parent=null;this.uiType="";this.children={};this.html=b("<div></div>");this.classes=[];this.id="";this.uiID=a;this.initialized=!1;this.state="normal";this.mouseHover=!1};a.UIElement.prototype.Initialize=function(){!0==this.initialized&&console.log("TomatoJS.UISystem: UIElement with id "+this.uiID+" was initialized twice!");this.initialized=!0;this.html.attr("id",this.id);this.html.addClass(this.uiType);for(var a in this.classes)this.html.addClass(this.classes[a]);
this.Invoke("Initialize");for(a in this.children)this.children[a].Initialize()};a.UIElement.prototype.Uninitialize=function(){!1==this.initialized&&console.log("TomatoJS.UISystem: UIElement with id "+this.uiID+" is not initialized, cannot be uninitialized");this.initialized=!1;this.Invoke("Uninitialize");for(var a in this.children)this.children[a].Uninitialize()};a.UIElement.prototype.AddChild=function(a){this.children[a.uiID]=a;a.parent=this;a.html.appendTo(this.html)};a.UIElement.prototype.RemoveChild=
function(a){delete this.children[a.uiID];a.Uninitialize();a.html.remove()};a.UIElement.prototype.GetChildHTML=function(a){return this.html.find(a)};a.UIElement.prototype.Remove=function(){this.parent&&this.parent.RemoveChild(this)};a.UIElement.prototype.GetGlobalPosition=function(){var a=[this.html.position().left,this.html.position().top],b=[0,0];this.parent&&(b=this.parent.GetGlobalPosition(),a[0]+=b[0],a[1]+=b[1]);return a};a.UIElement.prototype.Invoke=function(a,b){if(this.ui){for(var f=[],e=
1;e<arguments.length;++e)f.push(arguments[e]);(e=this.ui[a])&&e.apply(this.ui,f)}};a.UIElement.prototype.Destroy=function(){a.GetSystem("UISystem").DestroyUIElement(this.uiID)};a.UIElement.prototype.IsAlive=function(){return a.GetSystem("UISystem").GetUIElementById(this.uiID)?!0:!1}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b,d){function c(b,e){var h=b.CreateUIElement();if(e.include){var g=a.Core.resourceManager.GetUIPage(e.include);if(g==d)return console.log("TomatoJS.UISystem: Could not find UI Page with path "+e.include+" while resolving include from "+e.filepath),null;g.filePath=e.include;e=g}e["class"]&&(h.classes=e["class"].split(" "));h.id=e.id;h.x=e.x;h.y=e.y;if(a[e.type]==d)console.log("TomatoJS.UISystem: Could not create a UI Component of type "+e.type),console.log("TomatoJS.UISystem: Is it declared in the TomatoJS namespace and included?");
else{g=new a[e.type];g.parent=h;h.ui=g;h.uiType=e.type;for(var i in e)"x"!=i&&("y"!=i&&"children"!=i&&"type"!=i&&"class"!=i&&"id"!=i)&&(g[i]=e[i])}for(i in e.children)g=c(b,e.children[i]),h.AddChild(g);return h}a.UISystem=function(){this.uiBody=null;this.uiElements={};this.deleteList=[];this.currentId=0};a.UISystem.prototype.Initialize=function(){this.uiBody=this.CreateUIElement();this.uiBody.Initialize();this.uiBody.html.appendTo("body");this.uiBody.html.attr("id","UISystemBody");this.uiBody.html.css("width",
a.Core.configData.canvasSize[0]+"px");this.uiBody.html.css("height",a.Core.configData.canvasSize[1]+"px");this.uiBody.html.css("display","block");this.uiBody.html.css("transform","scale("+a.CoreScale+","+a.CoreScale+")");this.uiBody.html.css("transform-origin","0% 0%");this.uiBody.html.css("position","absolute");this.uiBody.html.css("left",a.Core.canvas.offsetLeft+"px");this.uiBody.html.css("top",a.Core.canvas.offsetTop+"px");this.uiBody.html.css("image-rendering","-webkit-optimize-contrast");this.uiBody.html.css("image-rendering",
"optimizeSpeed")};a.UISystem.prototype.Uninitialize=function(){this.uiBody=null};a.UISystem.prototype.AddEventListener=function(a,e,c){b(e).bind(a,c)};a.UISystem.prototype.RemoveEventListener=function(a,e,c){b(e).unbind(a,c)};a.UISystem.prototype.CreateUIElement=function(){var b=new a.UIElement(this.currentId++);return this.uiElements[b.uiID]=b};a.UISystem.prototype.AddChildToRoot=function(a){this.uiBody.AddChild(a)};a.UISystem.prototype.AddStyleSheet=function(c){b("head").append("<link rel='stylesheet' type='text/css' href='"+
a.Core.configData.uiStylePath+c+"' />")};a.UISystem.prototype.LoadUIPage=function(b){var e=a.Core.resourceManager.GetUIPage(b);e.filePath=b;if(e==d)return console.log("TomatoJS.UISystem: Could not find UI Page with path "+b),null;e=c(this,e);e.pageName=b;e.Initialize();return e};a.UISystem.prototype.DestroyUIElement=function(a){this.deleteList.push(a)};a.UISystem.prototype.GetUIElementById=function(a){return(a=this.uiElements[a])?a:null};a.UISystem.prototype.Update=function(){for(var a in this.deleteList){var b=
this.GetUIElementById(this.deleteList[a]);b.Uninitialize();delete this.uiElements[b.uiID]}this.deleteList=[]}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.PlatformController=function(a){this.parent=a;this.speed=80;this.jumpPower=270;this.editorEnabled=!1};a.PlatformController.prototype.Initialize=function(){a.Core.AddEventListener("OnFrameBegin",this)};a.PlatformController.prototype.Uninitialize=function(){a.Core.RemoveEventListener("OnFrameBegin",this)};a.PlatformController.prototype.OnFrameBegin=function(b){if(!a.Core.editorEnabled){var d=this.parent.GetComponent("TileCollider"),c=this.parent.GetComponent("RigidBody");a.Core.input.IsDown(a.Core.input.W)&&
(d&&c&&!0==d.grounded)&&(c.velocityY=-this.jumpPower);a.Core.input.IsDown(a.Core.input.A)&&(this.parent.x-=this.speed*b);a.Core.input.IsDown(a.Core.input.D)&&(this.parent.x+=this.speed*b);d=a.Core.GetSystem("Graphics");b=d.camera;c=d.canvas;d=c.width/a.CoreScale;c=c.height/a.CoreScale;this.parent.x-b.x>d-50?b.x+=this.parent.x-b.x-(d-50):50>this.parent.x-b.x&&(b.x-=50-(this.parent.x-b.x));this.parent.y-b.y>c-50?b.y+=this.parent.y-b.y-(c-50):50>this.parent.y-b.y&&(b.y-=50-(this.parent.y-b.y))}}})(window.TomatoJS=
window.TomatoJS||{},jQuery);(function(a){a.TopDownController=function(a){this.parent=a;this.speed=80};a.TopDownController.prototype.Initialize=function(){a.Core.AddEventListener("OnFrameBegin",this)};a.TopDownController.prototype.Uninitialize=function(){a.Core.RemoveEventListener("OnFrameBegin",this)};a.TopDownController.prototype.OnFrameBegin=function(b){if(!a.Core.editorEnabled){a.Core.input.IsDown(a.Core.input.W)&&(this.parent.y-=this.speed*b);a.Core.input.IsDown(a.Core.input.S)&&(this.parent.y+=this.speed*b);a.Core.input.IsDown(a.Core.input.A)&&
(this.parent.x-=this.speed*b);a.Core.input.IsDown(a.Core.input.D)&&(this.parent.x+=this.speed*b);var d=a.Core.GetSystem("Graphics"),b=d.camera,c=d.canvas,d=c.width/a.CoreScale,c=c.height/a.CoreScale;this.parent.x-b.x>d-50?b.x+=this.parent.x-b.x-(d-50):50>this.parent.x-b.x&&(b.x-=50-(this.parent.x-b.x));this.parent.y-b.y>c-50?b.y+=this.parent.y-b.y-(c-50):50>this.parent.y-b.y&&(b.y-=50-(this.parent.y-b.y))}}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.EditorController=function(a){this.parent=a;this.speed=120};a.EditorController.prototype.Initialize=function(){a.Core.AddEventListener("OnFrameBegin",this)};a.EditorController.prototype.Uninitialize=function(){a.Core.RemoveEventListener("OnFrameBegin",this)};a.EditorController.prototype.OnFrameBegin=function(b){a.Core.input.IsDown(a.Core.input.W)&&(this.parent.y-=this.speed*b);a.Core.input.IsDown(a.Core.input.S)&&(this.parent.y+=this.speed*b);a.Core.input.IsDown(a.Core.input.A)&&(this.parent.x-=
this.speed*b);a.Core.input.IsDown(a.Core.input.D)&&(this.parent.x+=this.speed*b);b=a.Core.GetSystem("Graphics").camera;a.Core.GetSystem("Graphics");b.x=this.parent.x;b.y=this.parent.y}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.ObjectSpawner=function(a){this.parent=a;this.spawnBlueprint=null;this.spawnTime=5;this.spawnOffsetY=this.spawnOffsetX=this.spawnTimer=0};a.ObjectSpawner.prototype.Initialize=function(){a.Core.AddEventListener("OnFrameBegin",this)};a.ObjectSpawner.prototype.Uninitialize=function(){a.Core.RemoveEventListener("OnFrameBegin",this)};a.ObjectSpawner.prototype.OnFrameBegin=function(b){this.spawnBlueprint&&!a.Core.editorEnabled&&(this.spawnTimer+=b,this.spawnTimer>=this.spawnTime&&(this.spawnTimer=
0,b=a.Core.LoadGameObject(this.spawnBlueprint),b.x=this.parent.x+this.spawnOffsetX,b.y=this.parent.y+this.spawnOffsetY))}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a){a.AudioEmitter=function(a){this.parent=a;this.soundBank={}};a.AudioEmitter.prototype.PlayBank=function(a,d){var c=this.soundBank[a];if(!c)return!1;var f=Math.floor(Math.random()*c.sounds.length);c.lastPlayedSound&&(f==c.lastPlayedSound&&1<c.sounds.length)&&(f=(f+1)%c.sounds.length);c.lastPlayedSound=f;this.PlaySound(c.sounds[f],c.radius,d)};a.AudioEmitter.prototype.PlaySound=function(b,d,c){var f=a.Core.GetSystem("TileSystem"),e=a.Core.GetSystem("Graphics").camera,h=a.Vec2DistancePoint([this.parent.x,
this.parent.y],[e.x,e.y]),e=1;d&&(e=h>d?0:1-h/d);c&&(e*=c);0<e&&a.Core.audio.PlaySound(b,!1,e);if(d){var b=[this.parent.x,this.parent.y],d=f.GetCollidersInRadius(b[0],b[1],d),g;for(g in d)d[g].parent.Invoke("OnHearSound",b[0],b[1],e)}}})(window.TomatoJS=window.TomatoJS||{},jQuery);(function(a,b,d){function c(){for(var b=0;b<a.Core.items_to_delete.length;++b){var c=a.Core.GetGameObjectById(a.Core.items_to_delete[b]);if(c){a.Core.DispatchEvent("OnObjectUninitialized",c);for(var d in c.components)c.components[d].Uninitialize&&c.components[d].Uninitialize();delete a.Core.game_objects[a.Core.items_to_delete[b]];delete a.Core.namedObjects[c.name]}}a.Core.items_to_delete=[]}function f(){var b=new Date,d=(b-a.Core.last_time)/1E3;0.05<d&&(d=0.05);a.Core.last_time=b;requestAnimFrame(f);
if(!a.Core.paused){this.elapsedTime+=d;a.Core.DispatchEvent("OnFrameBegin",d);for(var g in a.Core.deferredEvents)a.Core.DispatchEvent(a.Core.deferredEvents[g].eventName,a.Core.deferredEvents[g].args);a.Core.deferredEvents=[];a.Core.animator.Update(d);for(g=0;g<a.Core.systems.length;++g)a.Core.systems[g].Update&&a.Core.systems[g].Update(d);a.Core.DispatchEvent("OnFrameEnd",d);c()}}a.Core=0;String.prototype.startsWith=function(a){return this.match("^"+a)==a};String.prototype.endsWith=function(a){return this.match(a+
"$")==a};a.GameObject=function(a){this.id=a;this.y=this.x=0;this.name="";this.components={};this.flags={};this.initialized=!1};a.GameObject.prototype.Initialize=function(){!0==this.initialized&&console.log("TomatoJS.Core: Game Object with id "+this.id+" was initialized twice!");this.initialized=!0;for(var b in this.components)this.components[b].Initialize&&this.components[b].Initialize();for(b in this.components)this.components[b].PostInitialize&&this.components[b].PostInitialize();a.Core.DispatchEvent("OnObjectInitialized",
this)};a.GameObject.prototype.AddComponent=function(b){if(this.initialized)return console.log("TomatoJS.Core: Tried to add a component to an already initialized game object. (Not supported)"),!1;if(!a[b])return console.log("TomatoJS.Core: Could not find a class named "+b),console.log("TomatoJS.Core: Is it declared in the TomatoJS namespace and included?"),!1;var c=new a[b];c.parent=this;this.components[b]=c};a.GameObject.prototype.GetComponent=function(a){return this.components[a]?this.components[a]:
null};a.GameObject.prototype.AddFlag=function(a,b){return this.flags[a]=b};a.GameObject.prototype.GetFlag=function(a){return this.flags[a]};a.GameObject.prototype.Invoke=function(a,b){for(var c=[],d=1;d<arguments.length;++d)c.push(arguments[d]);for(d in this.components){var f=this.components[d][a];f&&f.apply(this.components[d],c)}};a.GameObject.prototype.SetName=function(b){a.Core.namedObjects[this.name]==this&&delete a.Core.namedObjects[this.name];this.name=b;if((b=a.Core.namedObjects[this.name])&&
b!=this)b.name="";a.Core.namedObjects[this.name]=this};a.GameObject.prototype.Destroy=function(){a.Core.DestroyGameObject(this.id)};a.GameObject.prototype.IsAlive=function(){return a.Core.GetGameObjectById(this.id)?!0:!1};a.GameObject.prototype.DistanceTo=function(a){return Math.sqrt((this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y))};a.Engine=function(){a.Core=this;this.last_time=new Date;this.paused=!1;this.systems=[];this.listeners={};this.deferredEvents=[];this.canvas=document.createElement("canvas");
b(this.canvas).attr("id","mainCanvas");this.showCursor=!0;b(this.canvas).css("margin-left","auto");b(this.canvas).css("margin-right","auto");b(this.canvas).css("display","block");document.body.appendChild(this.canvas);this.showCursor||b(this.canvas).css("cursor","none");this.fileManager=new a.FileManager;this.configFile=this.fileManager.OpenFile("Config.js");this.configData=this.configFile.GetJSONObject();this.configData.coreScale&&(a.CoreScale=this.configData.coreScale);this.input=new a.Input(this.canvas);
this.audio=new a.AudioBank;this.resourceManager=new a.ResourceManager;this.animator=new a.PropertyAnimator;this.canvas.width=this.configData.canvasSize[0]*a.CoreScale;this.canvas.height=this.configData.canvasSize[1]*a.CoreScale;this.current_id=0;this.game_objects={};this.namedObjects={};this.items_to_delete=[];this.editorEnabled=!1;this.elapsedTime=0;b(window).blur(function(){a.Core.DispatchEvent("OnWindowLoseFocus")});b(window).focus(function(){a.Core.DispatchEvent("OnWindowGainFocus")});window.requestAnimFrame=
window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}};a.Engine.prototype.Start=function(){this.resourceManager.Load(function(){for(var b=0;b<a.Core.systems.length;++b)a.Core.systems[b].Initialize&&a.Core.systems[b].Initialize();f()})};a.Engine.prototype.Pause=function(){this.paused=!0};a.Engine.prototype.UnPause=function(){this.paused=!1};a.Engine.prototype.AddSystem=
function(b){if(!a[b])return console.log("TomatoJS.Core: Could not find a class named "+b),console.log("TomatoJS.Core: Is it declared in the TomatoJS namespace and included?"),!1;var c=new a[b];c.systemName_=b;this.systems.push(c)};a.Engine.prototype.GetSystem=function(a){for(var b in this.systems)if(this.systems[b].systemName_==a)return this.systems[b];return null};a.Engine.prototype.AddEventListener=function(a,b){this.listeners[a]||(this.listeners[a]=[]);this.listeners[a].push(b)};a.Engine.prototype.RemoveEventListener=
function(a,b){if(this.listeners[a])for(var c in this.listeners[a])this.listeners[a][c]==b&&this.listeners[a].splice(c,1)};a.Engine.prototype.DispatchEvent=function(a,b){for(var c=[],f=1;f<arguments.length;++f)c.push(arguments[f]);var k=this.listeners[a];if(k)for(f in k){var j=k[f],l=j[a];l!=d&&l.apply(j,c)}};a.Engine.prototype.DispatchEventDeferred=function(a,b){this.deferredEvents.push({eventName:a,args:b})};a.Engine.prototype.CreateGameObject=function(){var b=new a.GameObject(this.current_id++);
return this.game_objects[b.id]=b};a.Engine.prototype.LoadGameObjectNamed=function(a,b,c){a=this.LoadGameObject(a,!0);if(""!=a.name){delete this.namedObjects[a.name];var d=this.namedObjects[b];d&&(d.name="")}a.name=b;this.namedObjects[b]=a;c||a.Initialize();return a};a.Engine.prototype.LoadGameObject=function(b,c){var f=this.resourceManager.GetBlueprint(b);if(f==d)return console.log("TomatoJS.Core: Could not find blueprint with name "+b),null;var i=this.CreateGameObject();i.blueprintName=b;f.name&&
(i.name=f.name);if(""!=i.name){var k=this.namedObjects[i.name];k&&(k.name="");this.namedObjects[i.name]=i}for(var j in f.flags)i.flags[j]=f.flags[j];for(j in f.components)if(a[j]==d)console.log("TomatoJS.Core: Could not create a component of type "+j),console.log("TomatoJS.Core: Is it declared in the TomatoJS namespace and included?");else{k=new a[j];k.parent=i;var l=f.components[j],m;for(m in l)k[m]=l[m];i.components[j]=k}c||i.Initialize();return i};a.Engine.prototype.GetBlueprint=function(a){return this.resourceManager.GetBlueprint(a)};
a.Engine.prototype.DestroyGameObject=function(a){a===d||null===a?console.log("TomatoJS.Core: "+a+" passed to DestroyGameObject()"):this.items_to_delete.push(a)};a.Engine.prototype.DestroyAllGameObjects=function(){for(var a in this.game_objects)this.game_objects[a].Destroy()};a.Engine.prototype.DestroyAllGameObjectsNow=function(){this.DestroyAllGameObjects();c()};a.Engine.prototype.GetGameObjectById=function(a){return(a=this.game_objects[a])?a:null};a.Engine.prototype.GetGameObjectByName=function(a){return(a=
this.namedObjects[a])?a:null}})(window.TomatoJS=window.TomatoJS||{},jQuery);
